<!DOCTYPE html>
<html lang="en">
  <head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<meta
  name="description"
  content="Design and implement your programming language and software analysis tools with mathematical rigor."
/>
<meta name="keywords" content="runtime, verification, rv, k" />
<meta name="author" content="IELE Semantics | Runtime Verification Inc" />
<meta name="robots" content="index, follow" />

<!--favicon icon-->
<link rel="icon" type="image/png" href="../assets/img/favicon.ico" />

<title>Michelson Semantics | Runtime Verification Inc</title>

<!-- <base href="/k/" /> -->

<!--web fonts-->
<link
  href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800"
  rel="stylesheet"
/>
<link
  href="https://fonts.googleapis.com/css?family=Lora:400i"
  rel="stylesheet"
/>

<link
  href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"
  rel="stylesheet"
/>

<link href="../assets/css/index.css" rel="stylesheet" />

<!--[if (gt IE 9) |!(IE)]><!-->
<!--<link rel="stylesheet" href="/assets/vendor/custom-nav/css/effects/fade-menu.css"/>-->
<!-- <link rel="stylesheet" href="../assets/k/vl-nav/css/effects/slide-menu.css" /> -->
<!--<![endif]-->

  </head>

  <body>
<header
  class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar"
>
  <a class="logo-link" href="../index.html"> IELE Semantics </a>
  <ul class="navbar-nav ml-md-auto">
    <li class="nav-item">
      <a
        class="nav-link pl-2 pr-1 mx-1 py-3 my-n2"
        href="https://github.com/runtimeverification/iele-semantics"
        target="_blank"
        rel="noopener"
        aria-label="GitHub"
      >
        <i class="fab fa-github"></i>
      </a>
    </li>
  </ul>
  <!--
  <a
    class="btn btn-rv-blue d-none d-lg-inline-block mb-3 mb-md-0 ml-md-3"
    href="../downloads"
    >Download</a
  >
  -->
</header>


    <div class="container-fluid">
      <div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 bd-sidebar mb-3">
  <form
    role="search"
    class="bd-search d-flex align-items-center justify-content-between"
  >
    <input
      type="search"
      class="form-control"
      placeholder="Search..."
      aria-label="Search for..."
      autocomplete="false"
      id="search-box"
    />
    <button
      class="btn bd-search-docs-toggle d-md-none p-0 ml-3 collapsed"
      type="button"
      aria-label="Toggle docs navigation"
      style="font-size: 1.4rem"
    >
      <i class="fas fa-bars"></i>
    </button>
  </form>
  <nav class="collapse bd-links" aria-label="Main navigation">
    <div class="bd-toc-item">
      <a class="bd-toc-link" href="../">Homepage</a>
      <a class="bd-toc-link" href="../INSTALL">Install</a>
      <a class="bd-toc-link" href="../USER_GUIDE">User Guide</a>
    </div>
  </nav>
</div>

        <main
          class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 bd-content"
          role="main"
        >
          <div class="markdown-preview"><html><head></head><body><pre class="language-k"><code><span class="token keyword">requires</span> <span class="token string">&quot;common.md&quot;</span>
<span class="token keyword">requires</span> <span class="token string">&quot;types.md&quot;</span>
</code></pre>
<h1 id="michelson-interpreter-state">Michelson Interpreter State</h1>
<pre class="language-k"><code><span class="token keyword">module</span> MICHELSON<span class="token operator">-</span>CONFIG
  <span class="token keyword">imports</span> MICHELSON<span class="token operator">-</span>COMMON
  <span class="token keyword">imports</span> DOMAINS
</code></pre>
<h2 id="the-k-michelson-configuration">The K-Michelson Configuration</h2>
<p>In K, the <code>configuration</code> captures a system&apos;s state, while <code>rule</code>s define how a
system transitions from one state to the next state. In this file, we define a
configuration for Michelson which captures three kinds of execution state:</p>
<ol>
<li>Tezos blockchain context: all of the Tezos blockchain state that is
accessible to a Michelson script, such as the current block creation time,
the current script address, etc...</li>
<li>Michelson runtime state: additional runtime state needed to execute a
Michelson script such as the Michelson script&apos;s current continuation and
stack, etc...</li>
<li>Additional test state: additional state needed to execute Michelson code in
precise configurations such as expected input and output stacks, pre- and
post-conditions, etc...</li>
</ol>
<p>Note that for K-Michelson, all type (1) configuration cells are <em>write-once</em> in
the sense that, once they are initialized, they are never changed. This is
precisely because K-Michelson is an <em>intra-contract</em> semantics, as we mentioned
above.</p>
<p>We first define a special directive <code>#Init</code> which we will describe later.</p>
<pre class="language-k"><code><span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#Init&quot;</span>
</code></pre>
<p>Here we declare our K-Michelson state configuration. We separate it into type
(1)-(3) configuration cells as listed above. By convention, we nest all state
cells inside a topmost cell, which we call <code>&lt;michelsonTop&gt;</code>.</p>
<pre class="language-k"><code>  <span class="token keyword">configuration</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>michelsonTop</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="tezos-blockchain-context">Tezos Blockchain Context</h3>
<p>As mentioned above, in K-Michelson, the Tezos blockchain context state cells are
all <em>write-once</em>, i.e. after initialization, they are never changed.</p>
<ol>
<li>
<p>We need to store the parameter type of the contract containing the Michelson
code to be executed. For standard Michelson contract execution, we also need
to know the parameter value that was passed in so we can properly initialize
the Michelson input stack.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>paramtype</span><span class="token punctuation">&gt;</span></span> #NotSet <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>paramtype</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>paramvalue</span><span class="token punctuation">&gt;</span></span> #NoData <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>paramvalue</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>We also need to store the storage type of the contract containing the
Michelson code to be executed as well as the contracts current storage
value.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>storagetype</span><span class="token punctuation">&gt;</span></span> #NotSet <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>storagetype</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>storagevalue</span><span class="token punctuation">&gt;</span></span> #NoData <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>storagevalue</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>Each contract has a remaining balance of mutez. The <code>BALANCE</code> instruction
pushes this value on the stack.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mybalance</span><span class="token punctuation">&gt;</span></span> #Mutez<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mybalance</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>Each contract is given a certain quantity of mutez when it is first
executed.  The <code>AMOUNT</code> instruction pushes this value to the stack.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>myamount</span><span class="token punctuation">&gt;</span></span> #Mutez<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>myamount</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>Each Michelson block has an associated creation timestamp. Blocks also
contain a list of transactions, including contract executions. Each
Michelson contract execution can access the timestamp of the block which
invoked it.  The <code>NOW</code> instruction pushes this value on the stack.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mynow</span><span class="token punctuation">&gt;</span></span> #Timestamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mynow</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>Each Michelson contract has an address. The <code>SELF</code> instruction combines this
value with the <code>&lt;paramtype&gt;</code> cell to produce a <code>contract</code> value that is
pushed on the stack. This value can be accessed by the snippet <code>SELF ; ADDRESS</code>. Note that a later amendment to the Tezos protocol may add a
<code>SELF_ADDRESS</code> instruction that would allow this value to be accessed
directly.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>myaddr</span><span class="token punctuation">&gt;</span></span> #Address<span class="token punctuation">(</span><span class="token string">&quot;InvalidMyAddr&quot;</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>myaddr</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>At any given moment, the Tezos current block has a certain number of
accounts with various parameter types. This cell stores the addresses and
types of all contract accounts on the curent Tezos block. The <code>CONTRACT</code>
instruction allows these values to be accessed.</p>
<p>N.B. The values in <code>&lt;myaddr&gt;</code>, <code>&lt;sourceaddr&gt;</code>, and <code>&lt;senderaddr&gt;</code> are not
required to be in this map. If they are not, then looking them up with the
<code>CONTRACT</code> instruction will return <code>None</code>.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>knownaddrs</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>knownaddrs</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>Each contract has a source contract (the one which initiated the entire
transaction and paid its fees). The<code>SOURCE</code> instruction pushes this address
on the stack.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sourceaddr</span><span class="token punctuation">&gt;</span></span> #Address<span class="token punctuation">(</span><span class="token string">&quot;InvalidSourceAddr&quot;</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sourceaddr</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>Each contract has a sender contract (the one which transferred tokens to
this one and directly caused its execution). The <code>SENDER</code> instruction pushes
this value on the stack.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>senderaddr</span><span class="token punctuation">&gt;</span></span> #Address<span class="token punctuation">(</span><span class="token string">&quot;InvalidSenderAddr&quot;</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>senderaddr</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>Each Tezos network (the global main network, global testing network, as
well as any local sandboxed networks for development) have their own
blockchain. A chain identifier identifies this execution context. The
<code>CHAIN_ID</code> instruction pushes the current chain identifier on the stack.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mychainid</span><span class="token punctuation">&gt;</span></span> #ChainId<span class="token punctuation">(</span><span class="token punctuation">.</span>Bytes<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mychainid</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>Each contract account contains a nonce which will be attached to any new
<code>operation</code> that this contract forges such that no two <code>operation</code>s will
share the same nonce (this restriction does not apply to any <code>operation</code>
that was copied via <code>DUP</code>). The operation nonce is not directly observable
by Michelson.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonce</span><span class="token punctuation">&gt;</span></span> #Nonce<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonce</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>Tezos provides two kinds of map-like data structures, <code>map</code> and <code>big_map</code>.
As maps, they are functionally equivalent --- the difference is that
<code>big_map</code>s are accessed and updated lazily, i.e. <code>big_map</code>s are:</p>
<ul>
<li>passed by reference;</li>
<li>particular values are only accessed on demand;</li>
<li>only updated in-place after contract execution --- any contract internal
updates are stored as a list of differences.</li>
</ul>
<p>As such, the Tezos blockchain context must maintain a table of pointers to
<code>big_map</code>s. This table is stored in the <code>&lt;bigmaps&gt;</code> configuration cell
below.  This table is represented by a map of integers (i.e. <code>big_map</code> ids)
to maps.</p>
<p>N.B. The semantics behavior is undefined if a <code>big_map</code> index occurs in a
Michelson code expression that is not set in this cell.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bigmaps</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bigmaps</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>The <code>&lt;script&gt;</code> cell stores the code of the smart contract to be executed.
However, since K-Michelson is a general semantics, the script cell may
include any valid Michelson expression, including expressions that
represent fragments of contracts and which are not complete contracts.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span> #NoData <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
</ol>
<h3 id="michelson-runtime-state">Michelson Runtime State</h3>
<p>As mentioned above, Michelson script execution requires additional runtime
state. We list the configuration cells storing this kind of state below.</p>
<ol>
<li>
<p>The <code>&lt;k&gt;</code> cell is the heart of a K semantics. It represents the current
<a href="https://en.wikipedia.org/wiki/Continuation" target="_blank" rel="noopener">continuation</a> of a program.</p>
<p>Initially, the continuation is just the Michelson contract/expression code
itself paired with the initialization function <code>#Init</code> (defined below).</p>
<p>As the program executes, its current continuation changes to represent the
currently to-be-executed computation. We represent this by dynamically
modifying the Michelson code contained in the <code>&lt;k&gt;</code> cell, e.g.&#xA0;the
continuation <code>&lt;k&gt; ADD ; SUB &lt;/k&gt;</code> reduces by an application of the semantic
rule defining the <code>ADD</code> instruction to the continuation <code>&lt;k&gt; SUB &lt;/k&gt;</code>.
Eventually, in case of a normal execution, the current continuation becomes
empty.</p>
<p>The special constant <code>#Init</code> is used to control initialization of each
semnatics. It works by having each driver module define a single rule of the
form: <code>rule #Init =&gt; ...</code>. This is needed because different drivers may need
to perform different pre-processing tasks.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> $PGM<span class="token punctuation">:</span>Pgm <span class="token operator">~&gt;</span> #Init <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>The <code>&lt;stack&gt;</code> cell contains the data on the stack of the current Michelson
program, and is initially empty. When we are executing a standard Michelson
contract, its initial form will always be:</p>
<p><code>Stack_elt (pair &apos;parameter_type &apos;storage_type)</code>.</p>
<p>In the general case, the stack may be initialized to any well-typed
Michelson stack.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">.</span>Stack<span class="token punctuation">)</span><span class="token punctuation">:</span>InternalStack <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
</ol>
<h3 id="additional-test-state">Additional Test State</h3>
<p>Finally, we have configuration cells which represent additional state only
useful for testing Michelson in precise configurations or for verification
of Michelson code. We list these configuration cells here:</p>
<ol>
<li>
<p>The <code>&lt;inputstack&gt;</code> cell contains the initial input stack for the given
Michelson execution as prescribed by the Michelson unit test format. Storing
this separately from the <code>&lt;stack&gt;</code> cell lets us remember the initial stack
information without worry that it will be clobbered during code execution.
It is useful for test execution, type-checking, and debugging purposes.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>inputstack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>StackElementList <span class="token punctuation">}</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>inputstack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>The <code>&lt;expected&gt;</code> cell contains the expected output stack for the given
Michelson execution as prescribed by the Michelson unit test format. It is
used for test validation, type-checking, and debugging purposes.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>expected</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token punctuation">.</span>StackElementList <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>OutputStack <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>expected</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>These cells contain pre- and post-conditions, as well as loop invariants.
These are useful when doing verification of Michelson expressions with
symbolic input and output values.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>BlockList <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>post</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>BlockList <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>post</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>invs</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>invs</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>In the symbolic semantics, the cutpoint cell contains a list of cutpoints
that have been visited.</p>
<pre class="language-text"><code>              &lt;cutpoints&gt; .Set &lt;/cutpoints&gt;
</code></pre>
</li>
<li>
<p>This cell lists the bindings between symbolic variables and their values. It
is only used when symbolically executing/verifying Michelson scripts.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>symbols</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>symbols</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>This cell stores the return code of the K-Michelson interpreter. It tracks
whether the Michelson code in question terminated properly as opposed to
getting stuck due to a type-error, ill-formed input, or a bug in the
semantics. It is initially set to <code>1</code> and changes to <code>0</code> when the script
executes successfully.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>returncode</span> <span class="token attr-name">exit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token number">1</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>returncode</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>The following cell is a debugging aid, indicating whether an <code>#Assume</code>
statement failed. It is primarily used during Michelson code verification.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assumeFailed</span><span class="token punctuation">&gt;</span></span> <span class="token boolean">false</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>assumeFailed</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
<li>
<p>The following cell is a debugging aid. It stores a sequence of strings
corresponding to all <code>TRACE</code> instructions reached during program execution.</p>
<pre class="language-k"><code>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trace</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>K <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trace</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</li>
</ol>
<p>Here we finalize the configuration declaration by closing the topmost
configuration cell.</p>
<pre class="language-k"><code>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>michelsonTop</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<pre class="language-k"><code><span class="token keyword">endmodule</span>
</code></pre>
<h1 id="michelson-semantics">Michelson Semantics</h1>
<p>This is the main execution semantics for Michelson. It contains the rewrite
rule semantics for the all Michelson instructions, as well as logic for
transforming values from their Micheline representations to K internal
representations. It also contains the .tzt file loading and contract
initialization logic.</p>
<p>We implement the unit test section of the .tzt format described by the
Tezos foundation
<a href="https://gitlab.com/tezos/tezos/-/merge_requests/1487/diffs" target="_blank" rel="noopener">here</a>. This file
implements the behavior of the &apos;code,&apos; &apos;input,&apos; and &apos;output&apos; applications
discussed in that document.</p>
<pre class="language-k"><code><span class="token keyword">module</span> MICHELSON
  <span class="token keyword">imports</span> MICHELSON<span class="token operator">-</span>CONFIG
  <span class="token keyword">imports</span> MATCHER
</code></pre>
<h2 id="semantics-initialization">Semantics Initialization</h2>
<p><code>#Init</code> takes care of initialization.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Init
        <span class="token operator">=&gt;</span> #ConvertBigMapsToNative
        <span class="token operator">~&gt;</span> #ConvertParamToNative
        <span class="token operator">~&gt;</span> #ConvertStorageToNative
        <span class="token operator">~&gt;</span> #ExecutePreConditions
        <span class="token operator">~&gt;</span> #InitInputStack
        <span class="token operator">~&gt;</span> #ExecuteScript
        <span class="token operator">~&gt;</span> #ExecutePostConditions
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="group-loading">Group Loading</h3>
<p>Below are the rules for loading specific groups.</p>
<h4 id="default-contract-groups">Default Contract Groups</h4>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> parameter T <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>paramtype</span><span class="token punctuation">&gt;</span></span> #NotSet <span class="token operator">=&gt;</span> T <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>paramtype</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> storage T <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>storagetype</span><span class="token punctuation">&gt;</span></span> #NotSet <span class="token operator">=&gt;</span> T <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>storagetype</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> code C <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span> #NoData <span class="token operator">=&gt;</span> C <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h4 id="extended-unit-test-gruops">Extended Unit Test Gruops</h4>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> G<span class="token punctuation">:</span>Group <span class="token punctuation">;</span> Gs<span class="token punctuation">:</span>Groups <span class="token operator">=&gt;</span> G<span class="token punctuation">:</span>Group <span class="token operator">~&gt;</span> Gs <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> now I <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mynow</span><span class="token punctuation">&gt;</span></span> #Timestamp<span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=&gt;</span> I<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mynow</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> sender A <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>senderaddr</span><span class="token punctuation">&gt;</span></span> #Address<span class="token punctuation">(</span><span class="token string">&quot;InvalidSenderAddr&quot;</span> <span class="token operator">=&gt;</span> A<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>senderaddr</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> source A <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sourceaddr</span><span class="token punctuation">&gt;</span></span> #Address<span class="token punctuation">(</span><span class="token string">&quot;InvalidSourceAddr&quot;</span> <span class="token operator">=&gt;</span> A<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sourceaddr</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> chain_id M <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mychainid</span><span class="token punctuation">&gt;</span></span> #ChainId<span class="token punctuation">(</span>_ <span class="token operator">=&gt;</span> M<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mychainid</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> self A <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>myaddr</span><span class="token punctuation">&gt;</span></span> #Address<span class="token punctuation">(</span><span class="token string">&quot;InvalidMyAddr&quot;</span> <span class="token operator">=&gt;</span> A<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>myaddr</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> amount I <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>myamount</span><span class="token punctuation">&gt;</span></span> #Mutez<span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=&gt;</span> I<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>myamount</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> #IsLegalMutezValue<span class="token punctuation">(</span>I<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> balance I <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mybalance</span><span class="token punctuation">&gt;</span></span> #Mutez<span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">=&gt;</span> I<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mybalance</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> #IsLegalMutezValue<span class="token punctuation">(</span>I<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> other_contracts <span class="token punctuation">{</span> M <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>knownaddrs</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token operator">=&gt;</span> #OtherContractsMapEntryListToKMap<span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>knownaddrs</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> big_maps <span class="token punctuation">{</span> M <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bigmaps</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map <span class="token operator">=&gt;</span> #BigMapsEntryListToKMap<span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bigmaps</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Map <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #BigMapsEntryListToKMap<span class="token punctuation">(</span>BigMapEntryList<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Map <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #BigMapsEntryToKMap<span class="token punctuation">(</span>BigMapEntry<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> #BigMapsEntryListToKMap<span class="token punctuation">(</span><span class="token punctuation">.</span>BigMapEntryList<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Map
  <span class="token keyword">rule</span> #BigMapsEntryListToKMap<span class="token punctuation">(</span>E <span class="token punctuation">;</span> Es<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #BigMapsEntryToKMap<span class="token punctuation">(</span>E<span class="token punctuation">)</span> #BigMapsEntryListToKMap<span class="token punctuation">(</span>Es<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#BigMap&quot;</span> <span class="token string">&quot;(&quot;</span> MapLiteral <span class="token string">&quot;,&quot;</span> Type <span class="token string">&quot;)&quot;</span>
  <span class="token keyword">rule</span> #BigMapsEntryToKMap<span class="token punctuation">(</span>Big_map I T1 T2 <span class="token punctuation">{</span> <span class="token punctuation">}</span>            <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> I <span class="token operator">|</span><span class="token operator">-</span>&gt; #BigMap<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> big_map <span class="token punctuation">.</span>AnnotationList T1 T2<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #BigMapsEntryToKMap<span class="token punctuation">(</span>Big_map I T1 T2 ML<span class="token punctuation">:</span>NeMapLiteral<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> I <span class="token operator">|</span><span class="token operator">-</span>&gt; #BigMap<span class="token punctuation">(</span>ML<span class="token punctuation">,</span>  big_map <span class="token punctuation">.</span>AnnotationList T1 T2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> invariant Annot <span class="token punctuation">{</span> Stack <span class="token punctuation">}</span> <span class="token punctuation">{</span> Blocks <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>invs</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>Map
           <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>Annot <span class="token operator">|</span><span class="token operator">-</span>&gt; <span class="token punctuation">{</span> Stack <span class="token punctuation">}</span> <span class="token punctuation">{</span> Blocks <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>invs</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> input LS <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>inputstack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>StackElementList <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> LS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>inputstack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> output OS <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>expected</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>StackElementList <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> OS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>expected</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> precondition <span class="token punctuation">{</span> Bs <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>BlockList <span class="token operator">=&gt;</span> Bs <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> postcondition <span class="token punctuation">{</span> Bs <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>post</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span>BlockList <span class="token operator">=&gt;</span> Bs <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>post</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="micheline-to-native-conversion">Micheline to Native Conversion</h3>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#ConvertBigMapsToNative&quot;</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #ConvertBigMapsToNative <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bigmaps</span><span class="token punctuation">&gt;</span></span> BigMaps <span class="token operator">=&gt;</span> #ConvertBigMapsToNative<span class="token punctuation">(</span>BigMaps<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bigmaps</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Map <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#ConvertBigMapsToNative&quot;</span> <span class="token string">&quot;(&quot;</span> Map <span class="token string">&quot;)&quot;</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> #ConvertBigMapsToNative<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Map
  <span class="token keyword">rule</span> #ConvertBigMapsToNative<span class="token punctuation">(</span>I <span class="token operator">|</span><span class="token operator">-</span>&gt; #BigMap<span class="token punctuation">(</span>D<span class="token punctuation">,</span> T<span class="token punctuation">)</span> BigMaps<span class="token punctuation">)</span>
   <span class="token operator">=&gt;</span> I <span class="token operator">|</span><span class="token operator">-</span>&gt; #MichelineToNative<span class="token punctuation">(</span>D<span class="token punctuation">,</span> T<span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">)</span> #ConvertBigMapsToNative<span class="token punctuation">(</span>BigMaps<span class="token punctuation">)</span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#ConvertParamToNative&quot;</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #ConvertParamToNative <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>paramvalue</span><span class="token punctuation">&gt;</span></span> D<span class="token punctuation">:</span>Data <span class="token operator">=&gt;</span> #MichelineToNative<span class="token punctuation">(</span>D<span class="token punctuation">,</span> #ConvertToType<span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">,</span> BigMaps<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>paramvalue</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>paramtype</span><span class="token punctuation">&gt;</span></span>  T      <span class="token operator">=&gt;</span> #ConvertToType<span class="token punctuation">(</span>T<span class="token punctuation">)</span>                                       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>paramtype</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bigmaps</span><span class="token punctuation">&gt;</span></span> BigMaps <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bigmaps</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #ConvertParamToNative <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>paramvalue</span><span class="token punctuation">&gt;</span></span> #NoData                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>paramvalue</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>paramtype</span><span class="token punctuation">&gt;</span></span>  T <span class="token operator">=&gt;</span> #ConvertToType<span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>paramtype</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#ConvertStorageToNative&quot;</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #ConvertStorageToNative <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>storagevalue</span><span class="token punctuation">&gt;</span></span> D<span class="token punctuation">:</span>Data <span class="token operator">=&gt;</span> #MichelineToNative<span class="token punctuation">(</span>D<span class="token punctuation">,</span> #ConvertToType<span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">,</span> BigMaps<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>storagevalue</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>storagetype</span><span class="token punctuation">&gt;</span></span>  T      <span class="token operator">=&gt;</span> #ConvertToType<span class="token punctuation">(</span>T<span class="token punctuation">)</span>                                       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>storagetype</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bigmaps</span><span class="token punctuation">&gt;</span></span> BigMaps <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bigmaps</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #ConvertStorageToNative <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>storagevalue</span><span class="token punctuation">&gt;</span></span> #NoData                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>storagevalue</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>storagetype</span><span class="token punctuation">&gt;</span></span>  T <span class="token operator">=&gt;</span> #ConvertToType<span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>storagetype</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Type <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #ConvertToType<span class="token punctuation">(</span>PreType<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> #ConvertToType<span class="token punctuation">(</span>#NotSet<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> unit <span class="token punctuation">.</span>AnnotationList
  <span class="token keyword">rule</span> #ConvertToType<span class="token punctuation">(</span>T<span class="token punctuation">:</span>Type<span class="token punctuation">)</span>  <span class="token operator">=&gt;</span> T
</code></pre>
<h3 id="type-checking">Type Checking</h3>
<p>Executing Michelson code without type information leads to non-determinism.
For example, the <code>CONCAT</code> instruction, when applied to an empty list, produces
either an empty <code>string</code> or empty <code>bytes</code>. Without knowing the type of the list,
the resulting type of value is unknown.</p>
<p>To correctly check the typing of a unit test, we need the following info:</p>
<ol>
<li>the contract parameter type --- only used in typing the <code>SELF</code> instruction</li>
<li>the input stack types --- which depend on (1) because <code>lambda</code></li>
<li>the output stack types --- which depend on (1) for the same reason</li>
<li>a Michelson script</li>
</ol>
<p>Currently, we implement runtime type checking. We may adopt static type
checking at a later time. All type checking requires looking at the top
fragment of of the stack only, with the exception of instructions which
have code in their immediate arguments (1-2) or execute <code>lambda</code>s (3).</p>
<ol>
<li>Checking if-like instructions <code>IF</code> and <code>IF_X</code> requires checking that both
branches produce the same the stack type.</li>
<li>Checking iterating instructions <code>LOOP</code> and <code>LOOP_LEFT</code>, <code>ITER</code>, and <code>MAP</code>
requires checking thet loop body code preserves the original stack type.</li>
<li>Checking function-call instruction <code>EXEC</code> requires checking the code
returns a singleton stack of the correct type.</li>
</ol>
<p>We currently do not implement the full typing semantics for cases (1)-(2).
Practically, this means that only <em>executed</em> code is type-checked, i.e. untaken
branches are not checked and loops are only checked for the exact number of
iterations for which they are run. This means that, even if some execution
succeeds, executing the other branch of an if instruction or executing a loop
a different number of times may cause the program to get stuck.</p>
<p><strong>TODO</strong>: the type of a <code>MAP</code> instruction over an empty <code>list</code> or <code>map</code> is
currently incorrectly calculated, as we assume it is equivalent to the original
<code>map</code> or <code>list</code> that was passed in, which disagrees with the intended
semantics that the type matches whatever the to-be executed code block does.</p>
<h4 id="typing-failwith">Typing <code>FAILWITH</code></h4>
<p>The <code>FAILWITH</code> instruction is interesting because its resulting type is the
<em>universal stack type</em> which unifies with all other stack types. However, due
to its unique semantics, it poisons all further computation, so that entire
program returns a <code>(Failed D)</code>. For this reason, from our experimentation, we
have observed the reference implementation makes two requirements on <code>FAILWITH</code>
instruction placement:</p>
<ol>
<li>
<p>It must occur last in the code block it appears in (this makes sense,
because all code following it is unreachable, i.e., dead).</p>
</li>
<li>
<p>It may not occur in positions that would prevent a concrete type from
being inferred. From our understanding, this can happen in two ways:</p>
<ul>
<li>code of the form <code>IF_X { ... ; FAILWITH } { ... ; FAILWITH }</code> which
prevents inferring a concrete stack type for the <code>IF_X</code> instruction;</li>
<li>code of the form <code>MAP { ... ; FAILWITH }</code> which prevents the inferring
a concrete value type for the resulting <code>map key_ty val_ty</code> or <code>list ty</code>
that it produces.</li>
</ul>
</li>
</ol>
<p>Currently, we do enforce these restrictions, but we may do so in a future
version.</p>
<h3 id="stack-initialization">Stack Initialization</h3>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#InitInputStack&quot;</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #InitInputStack <span class="token operator">=&gt;</span> #StackToNative<span class="token punctuation">(</span>Actual<span class="token punctuation">,</span> <span class="token punctuation">.</span>Stack<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>inputstack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span> Actual <span class="token punctuation">}</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>inputstack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #StackToNative<span class="token punctuation">(</span>StackElementList<span class="token punctuation">,</span> Stack<span class="token punctuation">)</span>
  <span class="token comment">// -----------------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #StackToNative<span class="token punctuation">(</span>Stack_elt T D <span class="token punctuation">;</span> Stack<span class="token punctuation">,</span> Stack&apos;<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> #StackToNative<span class="token punctuation">(</span>Stack<span class="token punctuation">,</span> <span class="token punctuation">[</span> #Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span> #MichelineToNative<span class="token punctuation">(</span>D<span class="token punctuation">,</span> T<span class="token punctuation">,</span> Addrs<span class="token punctuation">,</span> BigMaps<span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> Stack&apos;<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>knownaddrs</span><span class="token punctuation">&gt;</span></span> Addrs <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>knownaddrs</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bigmaps</span><span class="token punctuation">&gt;</span></span> BigMaps <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bigmaps</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> notBool isSymbolicData<span class="token punctuation">(</span>D<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #StackToNative<span class="token punctuation">(</span><span class="token punctuation">.</span>StackElementList<span class="token punctuation">,</span> Stack<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> reverseStack<span class="token punctuation">(</span>Stack<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<pre class="language-text"><code>  rule &lt;k&gt; (.K =&gt; #CreateSymbol(X, T))
        ~&gt; #StackToNative(Stack_elt T X:SymbolicData ; Stack, Stack&apos;)
           ...
       &lt;/k&gt;
       &lt;symbols&gt; Symbols  &lt;/symbols&gt;
    requires notBool X in_keys(Symbols)

  rule &lt;k&gt; #StackToNative(Stack_elt T X:SymbolicData ; Stack, Stack&apos;)
        =&gt; #StackToNative(Stack, [ TN D ] ; Stack&apos;)
           ...
       &lt;/k&gt;
       &lt;symbols&gt; X |-&gt; #TypedSymbol(TN, D) ... &lt;/symbols&gt;
    requires TN ==K #Name(T)
</code></pre>
<h3 id="code-execution">Code Execution</h3>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#ExecutePreConditions&quot;</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #ExecutePreConditions <span class="token operator">=&gt;</span> ASSUME <span class="token punctuation">{</span> Preconditions <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span> Preconditions <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#ExecutePostConditions&quot;</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #ExecutePostConditions
        <span class="token operator">=&gt;</span> BIND Expected <span class="token punctuation">{</span> ASSERT <span class="token punctuation">{</span> Postconditions <span class="token punctuation">}</span> <span class="token punctuation">}</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>expected</span><span class="token punctuation">&gt;</span></span> Expected <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>expected</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>post</span><span class="token punctuation">&gt;</span></span> Postconditions <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>post</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#ExecuteScript&quot;</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #ExecuteScript <span class="token operator">=&gt;</span> Script <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span> Script <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h1 id="execution-semantics">Execution Semantics</h1>
<h2 id="miscellaneous">Miscellaneous</h2>
<p>When the <code>&lt;k&gt;</code> cell is empty, we consider execution successful.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>returncode</span><span class="token punctuation">&gt;</span></span> <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token number">0</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>returncode</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>We handle sequence and block semantics here.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> I<span class="token punctuation">:</span>Instruction <span class="token punctuation">;</span> Is <span class="token operator">=&gt;</span> I <span class="token operator">~&gt;</span> Is <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>                 <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K      <span class="token punctuation">[</span>structrual<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> <span class="token punctuation">{</span> Is<span class="token punctuation">:</span>DataList <span class="token punctuation">}</span>    <span class="token operator">=&gt;</span> Is      <span class="token punctuation">[</span><span class="token class-name">structural</span><span class="token punctuation">]</span>
</code></pre>
<p>For now, we ignore annotations.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #HandleAnnotations<span class="token punctuation">(</span>AnnotationList<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #HandleAnnotations<span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>
</code></pre>
<h2 id="control-structures">Control Structures</h2>
<h3 id="user-defined-exceptions">User-defined Exceptions</h3>
<p>The <code>FAILWITH</code> instruction lets users terminate execution at any point.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> FAILWITH A <span class="token operator">~&gt;</span> Rk
        <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Aborted<span class="token punctuation">(</span><span class="token string">&quot;FAILWITH instruction reached&quot;</span><span class="token punctuation">,</span> D<span class="token punctuation">,</span> Rk<span class="token punctuation">,</span> Rs<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Rk
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> _Type D<span class="token punctuation">:</span>Data <span class="token punctuation">]</span> <span class="token punctuation">;</span> Rs <span class="token operator">=&gt;</span> <span class="token punctuation">(</span> Failed D <span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><code>Aborted()</code> contains error information when a contract fails at runtime.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Error <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> Aborted<span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token keyword">String</span><span class="token punctuation">,</span>
                           stackTop<span class="token punctuation">:</span> KItem<span class="token punctuation">,</span>
                           restOfStack<span class="token punctuation">:</span> K<span class="token punctuation">,</span>
                           restOfContinuation<span class="token punctuation">:</span> K<span class="token punctuation">)</span>
</code></pre>
<p>It then consumes the rest of the program:</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> Aborted<span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> <span class="token punctuation">(</span>_<span class="token punctuation">:</span>DataList <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> Aborted<span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> <span class="token punctuation">(</span>_<span class="token punctuation">:</span>Data <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Currently, if a program aborts due to the FAILWITH instruction, we throw away
the abortion debug info:</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>Aborted<span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> #ExecutePostConditions <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="conditionals">Conditionals</h3>
<p>The control flow instruction&apos;s implementations in K should look extremely
similar to their formal description in the <a href="https://tezos.gitlab.io/whitedoc/michelson.html#control-structures" target="_blank" rel="noopener">Michelson
documentation</a>.
Keeping this similarity, unless absolutely prevented for performance or K style
reasons, was a major design goal of the semantics.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IF A  BT _  <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> BT <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> bool <span class="token boolean">true</span>  <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IF A  _  BF <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> BF <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> bool <span class="token boolean">false</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="loops">Loops</h3>
<p>Here we handle concrete loop semantics.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LOOP <span class="token punctuation">.</span>AnnotationList Body
        <span class="token operator">=&gt;</span> Body <span class="token operator">~&gt;</span> LOOP <span class="token punctuation">.</span>AnnotationList Body
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> bool <span class="token boolean">true</span>  <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LOOP <span class="token punctuation">.</span>AnnotationList _ <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> bool <span class="token boolean">false</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LOOP_LEFT <span class="token punctuation">.</span>AnnotationList Body
        <span class="token operator">=&gt;</span> Body
        <span class="token operator">~&gt;</span> LOOP_LEFT <span class="token punctuation">.</span>AnnotationList Body
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>or LX _<span class="token punctuation">)</span> Left D <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
           <span class="token operator">=&gt;</span>  <span class="token punctuation">[</span> LX D <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LOOP_LEFT <span class="token punctuation">.</span>AnnotationList _ <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>or _ RX<span class="token punctuation">)</span> Right D <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> RX D <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Here we handle symbolic loop semantics.</p>
<pre class="language-text"><code>  rule &lt;k&gt; LOOP A .AnnotationList Body
        =&gt; CUTPOINT(!Id, Invariant) ;
           LOOP .AnnotationList {
             Body ;
             CUTPOINT(!Id, Invariant)
           }
           ...
       &lt;/k&gt;
       &lt;invs&gt; A |-&gt; Invariant ... &lt;/invs&gt;

  rule &lt;k&gt; LOOP_LEFT A .AnnotationList Body
        =&gt; CUTPOINT(!Id, Invariant) ;
           LOOP_LEFT .AnnotationList {
             Body ;
             CUTPOINT(!Id, Invariant)
           }
           ...
       &lt;/k&gt;
       &lt;invs&gt; A |-&gt; Invariant ... &lt;/invs&gt;
</code></pre>
<h3 id="stack-manipulation">Stack Manipulation</h3>
<p>It is sometimes useful to create &quot;pseudo-instructions&quot; like this to schedule
operations to happen in the future.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #Push<span class="token punctuation">(</span>TypeName<span class="token punctuation">,</span>Data<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Push<span class="token punctuation">(</span>T<span class="token punctuation">,</span>D<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> T D <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>The <code>DIP</code> instruction uses the <code>#Push</code> pseudo-instruction to replace the
element it pops off for its block.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DIP A B <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> B <span class="token operator">~&gt;</span> #Push<span class="token punctuation">(</span>T<span class="token punctuation">,</span>D<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> T D <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DIP A <span class="token number">0</span> B <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> B <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DIP A N B
         <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
         <span class="token operator">~&gt;</span> DIP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span> DIP <span class="token punctuation">.</span>AnnotationList N <span class="token operator">-</span><span class="token keyword">Int</span> <span class="token number">1</span> B <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> N &gt;<span class="token keyword">Int</span> <span class="token number">0</span>
</code></pre>
<p><code>DROP n</code> is implemented in a recursive style, like in the Michelson
documentation.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DROP A <span class="token operator">=&gt;</span>  #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> _<span class="token punctuation">:</span>StackElement <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DROP A I
        <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> DROP <span class="token punctuation">.</span>AnnotationList
        <span class="token operator">~&gt;</span> DROP <span class="token punctuation">.</span>AnnotationList I <span class="token operator">-</span><span class="token keyword">Int</span> <span class="token number">1</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> I &gt;<span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DROP A <span class="token number">0</span> <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><code>DUP</code> and <code>SWAP</code> are essentially lifted directly from the docs.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DUP A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> X<span class="token punctuation">:</span>StackElement <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> X <span class="token punctuation">;</span> X <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SWAP A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> X<span class="token punctuation">:</span>StackElement <span class="token punctuation">;</span> Y<span class="token punctuation">:</span>StackElement <span class="token punctuation">;</span> SS
            <span class="token operator">=&gt;</span> Y <span class="token punctuation">;</span> X <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><code>DIG n</code> and <code>DUG n</code> are both implemented using two internal instructions:
<code>X_DOWN</code> and <code>X_UP</code> which descend down to the <code>n</code>th stack position and then
climb back up, respectively.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DIG A N <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> DIG_DOWN<span class="token punctuation">(</span>N<span class="token punctuation">,</span> <span class="token punctuation">.</span>Stack<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;DIG_DOWN&quot;</span> <span class="token string">&quot;(&quot;</span> <span class="token keyword">Int</span> <span class="token string">&quot;,&quot;</span> Stack <span class="token string">&quot;)&quot;</span>
                       <span class="token operator">|</span> <span class="token string">&quot;DIG_UP&quot;</span> <span class="token string">&quot;(&quot;</span> Stack <span class="token string">&quot;,&quot;</span> StackElement <span class="token string">&quot;)&quot;</span>
  <span class="token comment">// -----------------------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DIG_DOWN<span class="token punctuation">(</span>N<span class="token punctuation">,</span> A<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DIG_DOWN<span class="token punctuation">(</span>N <span class="token operator">-</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">,</span> F <span class="token punctuation">;</span> A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> F <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> N &gt;<span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DIG_DOWN<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> A<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DIG_UP<span class="token punctuation">(</span>A<span class="token punctuation">,</span> F<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> F <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DIG_UP<span class="token punctuation">(</span>F <span class="token punctuation">;</span> A<span class="token punctuation">,</span> T<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DIG_UP<span class="token punctuation">(</span>A<span class="token punctuation">,</span> T<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> F <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DIG_UP<span class="token punctuation">(</span><span class="token punctuation">.</span>Stack<span class="token punctuation">,</span> T<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> T <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DUG A N <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> DUG_DOWN<span class="token punctuation">(</span>N<span class="token punctuation">,</span> <span class="token punctuation">.</span>Stack<span class="token punctuation">,</span> T<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> T <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;DUG_DOWN&quot;</span> <span class="token string">&quot;(&quot;</span> <span class="token keyword">Int</span> <span class="token string">&quot;,&quot;</span> Stack <span class="token string">&quot;,&quot;</span> StackElement <span class="token string">&quot;)&quot;</span>
                       <span class="token operator">|</span> <span class="token string">&quot;DUG_UP&quot;</span> <span class="token string">&quot;(&quot;</span> K <span class="token string">&quot;)&quot;</span>
  <span class="token comment">// ---------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DUG_DOWN<span class="token punctuation">(</span>N<span class="token punctuation">,</span> S<span class="token punctuation">,</span> R<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DUG_DOWN<span class="token punctuation">(</span>N <span class="token operator">-</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">,</span> T <span class="token punctuation">;</span> S<span class="token punctuation">,</span> R<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> T <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> N &gt;<span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DUG_DOWN<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> S<span class="token punctuation">,</span> R<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DUG_UP<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> R <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DUG_UP<span class="token punctuation">(</span>T<span class="token punctuation">:</span>StackElement <span class="token punctuation">;</span> S<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DUG_UP<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> T <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DUG_UP<span class="token punctuation">(</span><span class="token punctuation">.</span>Stack<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h4 id="push-like-instructions"><code>PUSH</code>-like Instructions</h4>
<p><code>PUSH</code> puts its syntactic argument on the stack <em>when it is a <code>Value</code></em>.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> PUSH A T X <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> #Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span> X <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>#Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span> X<span class="token punctuation">)</span>
</code></pre>
<p>If it is not a <code>Value</code>, <code>PUSH</code> converts its argument to a <code>Value</code>, either by
converting the parse-time representation to an internal one or else by looking
up/creating a new symbol in the symbol table.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> PUSH _ T <span class="token punctuation">(</span>X <span class="token operator">=&gt;</span> #MichelineToNative<span class="token punctuation">(</span>X<span class="token punctuation">,</span> T<span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> notBool isValue<span class="token punctuation">(</span>#Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span> X<span class="token punctuation">)</span>
     andBool notBool isSymbolicData<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
</code></pre>
<pre class="language-text"><code>  rule &lt;k&gt; PUSH _ T (X:SymbolicData =&gt; D)  ... &lt;/k&gt;
       &lt;symbols&gt; X |-&gt; #TypedSymbol(TN, D) ... &lt;/symbols&gt;
    requires #Name(T) ==K TN

  rule &lt;k&gt; (.K =&gt; #CreateSymbol(X, T)) ~&gt; PUSH A T X:SymbolicData  ... &lt;/k&gt;
       &lt;symbols&gt; Symbols  &lt;/symbols&gt;
    requires notBool X in_keys(Symbols)
</code></pre>
<p><code>UNIT</code> and <code>LAMBDA</code> are specialized versions of <code>PUSH</code>.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> UNIT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> unit  Unit<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LAMBDA A T1 T2 C <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>lambda #Name<span class="token punctuation">(</span>T1<span class="token punctuation">)</span> #Name<span class="token punctuation">(</span>T2<span class="token punctuation">)</span><span class="token punctuation">)</span> #Lambda<span class="token punctuation">(</span>#Name<span class="token punctuation">(</span>T1<span class="token punctuation">)</span><span class="token punctuation">,</span> #Name<span class="token punctuation">(</span>T2<span class="token punctuation">)</span><span class="token punctuation">,</span> C<span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="lambda-evaluation">Lambda Evaluation</h3>
<p>An <code>EXEC</code> instruction replaces the stack and schedules the restoration of the
old stack after the completion of the lambda code.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EXEC B
        <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>B<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Code
        <span class="token operator">~&gt;</span> #PostExecStackFix<span class="token punctuation">(</span>RetType<span class="token punctuation">,</span> SS<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> ArgType D <span class="token punctuation">]</span>
             <span class="token punctuation">;</span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>lambda ArgType RetType<span class="token punctuation">)</span> #Lambda<span class="token punctuation">(</span>ArgType<span class="token punctuation">,</span> RetType<span class="token punctuation">,</span> Code<span class="token punctuation">)</span> <span class="token punctuation">]</span>
             <span class="token punctuation">;</span> SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> ArgType D <span class="token punctuation">]</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #PostExecStackFix<span class="token punctuation">(</span>TypeName<span class="token punctuation">,</span>Stack<span class="token punctuation">)</span>
  <span class="token comment">// -----------------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #PostExecStackFix<span class="token punctuation">(</span>RetType<span class="token punctuation">,</span> SS<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> RetType D <span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> RetType D <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><code>APPLY</code> demonstrates why lambdas have their type information preserved, as
otherwise we would be unable to produce an appropriate <code>PUSH</code> instruction for
the expanded lambda.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> APPLY A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> T0 D <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span> <span class="token punctuation">(</span>lambda <span class="token punctuation">(</span>pair T0 T1<span class="token punctuation">)</span> T2<span class="token punctuation">)</span>
                 #Lambda<span class="token punctuation">(</span><span class="token punctuation">(</span>pair T0 T1<span class="token punctuation">)</span><span class="token punctuation">,</span> T2<span class="token punctuation">,</span> <span class="token punctuation">{</span> C <span class="token punctuation">}</span> <span class="token punctuation">)</span>
               <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>lambda T1 T2<span class="token punctuation">)</span> #Lambda<span class="token punctuation">(</span>T1<span class="token punctuation">,</span> T2<span class="token punctuation">,</span> <span class="token punctuation">{</span> PUSH <span class="token punctuation">.</span>AnnotationList #Type<span class="token punctuation">(</span>T0<span class="token punctuation">)</span> D <span class="token punctuation">;</span>
                                                  PAIR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
                                                  <span class="token punctuation">{</span> C <span class="token punctuation">}</span>
                                                <span class="token punctuation">}</span> <span class="token punctuation">)</span>
               <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h2 id="core-operations">Core Operations</h2>
<h3 id="generic-comparison">Generic Comparison</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EQ A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> int I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> bool I <span class="token operator">==</span><span class="token keyword">Int</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> NEQ A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> int I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> bool I <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span><span class="token keyword">Int</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> int I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> bool I &lt;<span class="token keyword">Int</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> GT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> int I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> bool I &gt;<span class="token keyword">Int</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> int I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> bool I <span class="token operator">&lt;=</span><span class="token keyword">Int</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> GE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> int I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> bool I <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>We add lemmas for symbolic reasoning which normalize integer comparisons to
greater than; this lets us avoid writing symmetric lemmas for both cases.</p>
<pre class="language-text"><code>    rule A  &lt;Int B =&gt; B &gt;Int  A [simplification]
    rule A &lt;=Int B =&gt; B &gt;=Int A [simplification]
</code></pre>
<h3 id="boolean-operations">Boolean Operations</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> OR A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> bool B1 <span class="token punctuation">]</span>
             <span class="token punctuation">;</span> <span class="token punctuation">[</span> bool B2 <span class="token punctuation">]</span>
             <span class="token punctuation">;</span> SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> bool <span class="token punctuation">(</span>B1 orBool B2<span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> AND A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> bool B1 <span class="token punctuation">]</span>
             <span class="token punctuation">;</span> <span class="token punctuation">[</span> bool B2 <span class="token punctuation">]</span>
             <span class="token punctuation">;</span> SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> bool <span class="token punctuation">(</span>B1 andBool B2<span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> XOR A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> bool B1 <span class="token punctuation">]</span>
             <span class="token punctuation">;</span> <span class="token punctuation">[</span> bool B2 <span class="token punctuation">]</span>
             <span class="token punctuation">;</span> SS
             <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> bool <span class="token punctuation">(</span>B1 xorBool B2<span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> NOT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> bool B <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> bool <span class="token punctuation">(</span>notBool B<span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>For symbolic reasoning purposes, we add a few lemmas about boolean logic.</p>
<pre class="language-text"><code>  rule false      ==Bool B            =&gt; notBool B    [simplification]
  rule true       ==Bool B            =&gt; B            [simplification]
  rule B          ==Bool false        =&gt; notBool B    [simplification]
  rule B          ==Bool true         =&gt; B            [simplification]
  rule notBool (notBool B)            =&gt; B            [simplification]
  rule notBool B1 ==Bool notBool B2   =&gt; B1 ==Bool B2 [simplification]
</code></pre>
<h3 id="integer-and-natural-operations">Integer and Natural Operations</h3>
<p>Michelson <code>int</code> and <code>nat</code> datatypes are both represnted using the K <code>Int</code> type.
These operations map directly to their K equivalents.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> NEG A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> _<span class="token punctuation">:</span>NumTypeName I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> int <span class="token number">0</span> <span class="token operator">-</span><span class="token keyword">Int</span> I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ABS A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> int I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> nat absInt<span class="token punctuation">(</span>I<span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ISNAT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> int I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>option nat<span class="token punctuation">)</span> Some I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token keyword">requires</span> I <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ISNAT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> int I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>option nat<span class="token punctuation">)</span> None <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token keyword">requires</span> I <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Int</span> <span class="token attr-name">0</span>

  <span class="token attr-name">rule</span> <span class="token attr-name">&lt;k</span><span class="token punctuation">&gt;</span></span> INT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>nat <span class="token operator">=&gt;</span> int<span class="token punctuation">)</span> _<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> _ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ADD A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> T1<span class="token punctuation">:</span>NumTypeName I1 <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span> T2<span class="token punctuation">:</span>NumTypeName I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> BinOpNumType<span class="token punctuation">(</span>T1<span class="token punctuation">,</span>T2<span class="token punctuation">)</span> I1 <span class="token operator">+</span><span class="token keyword">Int</span> I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SUB A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> _<span class="token punctuation">:</span>NumTypeName I1 <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span> _<span class="token punctuation">:</span>NumTypeName I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> int I1 <span class="token operator">-</span><span class="token keyword">Int</span> I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> MUL A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> T1<span class="token punctuation">:</span>NumTypeName I1 <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span> T2<span class="token punctuation">:</span>NumTypeName I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> BinOpNumType<span class="token punctuation">(</span>T1<span class="token punctuation">,</span>T2<span class="token punctuation">)</span> I1 <span class="token operator">*</span><span class="token keyword">Int</span> I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EDIV A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> T1<span class="token punctuation">:</span>NumTypeName _<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span> T2<span class="token punctuation">:</span>NumTypeName <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>option <span class="token punctuation">(</span>pair BinOpNumType<span class="token punctuation">(</span>T1<span class="token punctuation">,</span>T2<span class="token punctuation">)</span> nat<span class="token punctuation">)</span><span class="token punctuation">)</span> None <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EDIV A  <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> T1<span class="token punctuation">:</span>NumTypeName I1<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span> T2<span class="token punctuation">:</span>NumTypeName I2<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">(</span>option <span class="token punctuation">(</span>pair BinOpNumType<span class="token punctuation">(</span>T1<span class="token punctuation">,</span>T2<span class="token punctuation">)</span> nat<span class="token punctuation">)</span><span class="token punctuation">)</span>
                   Some <span class="token punctuation">(</span>Pair <span class="token punctuation">(</span>I1 <span class="token operator">/</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span> <span class="token punctuation">(</span>I1 <span class="token operator">%</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token keyword">requires</span> I2 <span class="token operator">=</span><span class="token operator">/</span><span class="token operator">=</span><span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">syntax</span> NumTypeName <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> BinOpNumType<span class="token punctuation">(</span>NumTypeName<span class="token punctuation">,</span> NumTypeName<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> BinOpNumType<span class="token punctuation">(</span>_<span class="token punctuation">:</span>NumTypeName<span class="token punctuation">,</span> int<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> int
  <span class="token keyword">rule</span> BinOpNumType<span class="token punctuation">(</span>int<span class="token punctuation">,</span> _<span class="token punctuation">:</span>NumTypeName<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> int
  <span class="token keyword">rule</span> BinOpNumType<span class="token punctuation">(</span>nat<span class="token punctuation">,</span> nat<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> nat
</code></pre>
<p>For symbolic reasoning purposes, we add some simple lemmas about arithmetic:</p>
<pre class="language-text"><code>  rule V:Int -Int V:Int =&gt; 0 [simplification]
</code></pre>
<p>Bitwise operations on Michelson <code>int</code>s map directly onto K <code>Int</code> functions.
The <code>LSL</code> and <code>LSR</code> operations produce exceptions when their shift arugment
overflows.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> OR A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> nat I1 <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span> nat I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> nat I1 <span class="token operator">|</span><span class="token keyword">Int</span> I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> AND A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> _<span class="token punctuation">:</span>NumTypeName I1 <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span> nat I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> nat I1 <span class="token operator">&amp;</span><span class="token keyword">Int</span> I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> XOR A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> nat I1 <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span> nat I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> nat I1 xorInt I2 <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> NOT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> _<span class="token punctuation">:</span>NumTypeName I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> int <span class="token operator">~</span><span class="token keyword">Int</span> I <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LSL A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> nat X <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span> nat S <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> nat X &lt;&lt;<span class="token keyword">Int</span> S <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> S <span class="token operator">&lt;=</span><span class="token keyword">Int</span> <span class="token number">256</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LSL A <span class="token operator">~&gt;</span> Rk
        <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Aborted<span class="token punctuation">(</span><span class="token string">&quot;LSL out of range&quot;</span><span class="token punctuation">,</span> S<span class="token punctuation">,</span> Rk<span class="token punctuation">,</span> Rs<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Rk
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> nat C<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span> nat S<span class="token punctuation">:</span><span class="token keyword">Int</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> Rs <span class="token operator">=&gt;</span> <span class="token punctuation">(</span> GeneralOverflow C S <span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> S &gt;<span class="token keyword">Int</span> <span class="token number">256</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LSR A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> nat X <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span> nat S <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> nat X &gt;&gt;<span class="token keyword">Int</span> S <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> S <span class="token operator">&lt;=</span><span class="token keyword">Int</span> <span class="token number">256</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LSR A <span class="token operator">~&gt;</span> Rk
        <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Aborted<span class="token punctuation">(</span><span class="token string">&quot;LSR out of range&quot;</span><span class="token punctuation">,</span> S<span class="token punctuation">,</span> Rk<span class="token punctuation">,</span> Rs<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Rk
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> nat X <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span> nat S <span class="token punctuation">]</span> <span class="token punctuation">;</span> Rs <span class="token operator">=&gt;</span> <span class="token punctuation">(</span> GeneralOverflow X S <span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token keyword">requires</span> S &gt;<span class="token keyword">Int</span> <span class="token number">256</span>
</code></pre>
<h3 id="compare-instruction"><code>COMPARE</code> Instruction</h3>
<p>The <code>COMPARE</code> instruction is defined over all comparable datatypes.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> COMPARE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span> TY V1 <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span> TY V2 <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span> int #DoCompare<span class="token punctuation">(</span>V1<span class="token punctuation">,</span> V2<span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> #IsComparable<span class="token punctuation">(</span>TY<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> <span class="token keyword">Bool</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #IsComparable<span class="token punctuation">(</span>TypeName<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
  <span class="token comment">// Comparables</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>_<span class="token punctuation">:</span>NumTypeName<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>mutez<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>bool<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>key_hash<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>address<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>pair T1 T2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #IsComparable<span class="token punctuation">(</span>T1<span class="token punctuation">)</span> andBool #IsComparable<span class="token punctuation">(</span>T2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>option _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>

  <span class="token comment">// Nullary Incomparables</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>unit<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>operation<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>chain_id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>

  <span class="token comment">// Unary Incomparables</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>list _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>set _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>contract _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>

  <span class="token comment">// Bianry Incomparables</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>or _ _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>lambda _ _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>map _ _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> #IsComparable<span class="token punctuation">(</span>big_map _ _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
</code></pre>
<p>We define <code>COMPARE</code> in terms of a <code>#DoCompare</code> function.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> <span class="token keyword">Int</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #DoCompare<span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Data<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>V<span class="token punctuation">,</span> V<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">0</span>

  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span>

  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>I1<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> I2<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">requires</span> I1 &lt;<span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>I1<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> I2<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">0</span> <span class="token keyword">requires</span> I1 <span class="token operator">==</span><span class="token keyword">Int</span> I2
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>I1<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">,</span> I2<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span> <span class="token keyword">requires</span> I1 &gt;<span class="token keyword">Int</span> I2

  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>S1<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">,</span> S2<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">requires</span> S1 &lt;<span class="token keyword">String</span> S2
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>S1<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">,</span> S2<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">0</span> <span class="token keyword">requires</span> S1 <span class="token operator">==</span><span class="token keyword">String</span> S2
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>S1<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">,</span> S2<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span> <span class="token keyword">requires</span> S1 &gt;<span class="token keyword">String</span> S2

  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>None<span class="token punctuation">,</span>    Some _ <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>Some _<span class="token punctuation">,</span>  None   <span class="token punctuation">)</span> <span class="token operator">=&gt;</span>  <span class="token number">1</span>
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>Some V1<span class="token punctuation">,</span> Some V2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #DoCompare<span class="token punctuation">(</span>V1<span class="token punctuation">,</span> V2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span><span class="token punctuation">(</span>Pair A1 _ <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Pair B1 _ <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">-</span><span class="token number">1</span>                 <span class="token keyword">requires</span> #DoCompare<span class="token punctuation">(</span>A1<span class="token punctuation">,</span> B1<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">Int</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span><span class="token punctuation">(</span>Pair A1 A2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Pair B1 B2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #DoCompare<span class="token punctuation">(</span>A2<span class="token punctuation">,</span> B2<span class="token punctuation">)</span> <span class="token keyword">requires</span> #DoCompare<span class="token punctuation">(</span>A1<span class="token punctuation">,</span> B1<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">Int</span> <span class="token number">0</span>
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span><span class="token punctuation">(</span>Pair A1 _ <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Pair B1 _ <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span>                  <span class="token keyword">requires</span> #DoCompare<span class="token punctuation">(</span>A1<span class="token punctuation">,</span> B1<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">Int</span> <span class="token number">1</span>

  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>B1<span class="token punctuation">:</span>Bytes<span class="token punctuation">,</span> B2<span class="token punctuation">:</span>Bytes<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #DoCompare<span class="token punctuation">(</span>Bytes2Int<span class="token punctuation">(</span>B1<span class="token punctuation">,</span> BE<span class="token punctuation">,</span> Unsigned<span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes2Int<span class="token punctuation">(</span>B2<span class="token punctuation">,</span> BE<span class="token punctuation">,</span> Unsigned<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>#KeyHash<span class="token punctuation">(</span>S1<span class="token punctuation">)</span><span class="token punctuation">,</span> #KeyHash<span class="token punctuation">(</span>S2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #DoCompare<span class="token punctuation">(</span>S1<span class="token punctuation">,</span> S2<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>#Mutez<span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">,</span> #Mutez<span class="token punctuation">(</span>I2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #DoCompare<span class="token punctuation">(</span>I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>#Timestamp<span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">,</span> #Timestamp<span class="token punctuation">(</span>I2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #DoCompare<span class="token punctuation">(</span>I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #DoCompare<span class="token punctuation">(</span>#Address<span class="token punctuation">(</span>S1<span class="token punctuation">)</span><span class="token punctuation">,</span> #Address<span class="token punctuation">(</span>S2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #DoCompare<span class="token punctuation">(</span>S1<span class="token punctuation">,</span> S2<span class="token punctuation">)</span>
</code></pre>
<p>The <code>#DoCompare</code> function requires additional lemmas for symbolic execution.</p>
<pre class="language-text"><code>  rule 0 ==Int  #DoCompare(V1, V2) =&gt; V1  ==K V2  [simplification]
  rule 0 =/=Int #DoCompare(V1, V2) =&gt; V1 =/=K V2  [simplification]
  rule #DoCompare(V1, V2)  ==Int 0 =&gt; V1  ==K V2  [simplification]
  rule #DoCompare(V1, V2) =/=Int 0 =&gt; V1 =/=K V2  [simplification]

  rule 0  &gt;Int #DoCompare(I1:Bool, I2:Bool) =&gt; (notBool I1) andBool I2 [simplification]
  rule 0 &gt;=Int #DoCompare(I1:Bool, I2:Bool) =&gt; I1 impliesBool I2       [simplification]
  rule #DoCompare(I1:Bool, I2:Bool) &gt;=Int 0 =&gt; I2 impliesBool I1       [simplification]
  rule #DoCompare(I1:Bool, I2:Bool)  &gt;Int 0 =&gt; I1 andBool (notBool I2) [simplification]

  rule 0  &gt;Int #DoCompare(I1:Int, I2:Int) =&gt; I2 &gt;Int I1  [simplification]
  rule 0 &gt;=Int #DoCompare(I1:Int, I2:Int) =&gt; I2 &gt;=Int I1 [simplification]
  rule #DoCompare(I1:Int, I2:Int) &gt;=Int 0 =&gt; I1 &gt;=Int I2 [simplification]
  rule #DoCompare(I1:Int, I2:Int) &gt;Int 0  =&gt; I1 &gt;Int I2  [simplification]

  rule 0  &gt;Int #DoCompare(I1:String, I2:String) =&gt; I1 &lt;String I2  [simplification]
  rule 0 &gt;=Int #DoCompare(I1:String, I2:String) =&gt; I1 &lt;=String I2 [simplification]
  rule #DoCompare(I1:String, I2:String) &gt;=Int 0 =&gt; I1 &gt;=String I2 [simplification]
  rule #DoCompare(I1:String, I2:String)  &gt;Int 0 =&gt; I1 &gt;String I2  [simplification]

  // TODO: at some point this rule should be builtin
  rule X ==String X =&gt; true [simplification]
</code></pre>
<h3 id="string-operations">String Operations</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CONCAT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>string S1<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>string S2<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>string S1 <span class="token operator">+</span><span class="token keyword">String</span> S2<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CONCAT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span><span class="token punctuation">(</span>list string<span class="token punctuation">)</span> L<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>string #ConcatStrings<span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SIZE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>string S<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>nat lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> <span class="token keyword">String</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #ConcatStrings<span class="token punctuation">(</span>InternalList<span class="token punctuation">,</span> <span class="token keyword">String</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">// --------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #ConcatStrings<span class="token punctuation">(</span><span class="token punctuation">.</span>InternalList<span class="token punctuation">,</span> A<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> A
  <span class="token keyword">rule</span> #ConcatStrings<span class="token punctuation">(</span><span class="token punctuation">[</span> S1 <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> DL<span class="token punctuation">,</span>  A<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #ConcatStrings<span class="token punctuation">(</span>DL<span class="token punctuation">,</span> A <span class="token operator">+</span><span class="token keyword">String</span> S1<span class="token punctuation">)</span>
</code></pre>
<p>The actual out of bounds conditions here are determined by experimentation.
Earlier versions of the semantics didn&apos;t check if O was in bounds, resulting in
<code>Slice(&quot;&quot;, 0, 0) =&gt; Some &quot;&quot;</code> rather than the correct
<code>#SliceString(&quot;&quot;, 0, 0) =&gt; None</code></p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SLICE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>nat O<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>nat L<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>string S<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option string #SliceString<span class="token punctuation">(</span>S<span class="token punctuation">,</span> O<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> OptionData <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #SliceString<span class="token punctuation">(</span><span class="token keyword">String</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> #SliceString<span class="token punctuation">(</span>S<span class="token punctuation">,</span> O<span class="token punctuation">,</span> L<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Some substrString<span class="token punctuation">(</span>S<span class="token punctuation">,</span> O<span class="token punctuation">,</span> O <span class="token operator">+</span><span class="token keyword">Int</span> L<span class="token punctuation">)</span>
    <span class="token keyword">requires</span> O <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
     andBool L <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
     andBool O &lt;<span class="token keyword">Int</span> lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span>
     andBool <span class="token punctuation">(</span>O <span class="token operator">+</span><span class="token keyword">Int</span> L<span class="token punctuation">)</span> <span class="token operator">&lt;=</span><span class="token keyword">Int</span> lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #SliceString<span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> None <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>
</code></pre>
<h3 id="bytes-operations">Bytes Operations</h3>
<p>The bytes instructions have a stubbed implementation for the time being, since
the actual serialization format is not formally unspecified.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> PACK A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>T V<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>bytes #Packed<span class="token punctuation">(</span>T<span class="token punctuation">,</span>V<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> UNPACK A _ <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>bytes #Packed<span class="token punctuation">(</span>T<span class="token punctuation">,</span>V<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option T Some V<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>The <code>CONCAT</code> operation over two bytes is relatively straightforward since we
already have helper functions to extract bytes content.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CONCAT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>bytes B1<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>bytes B2<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>bytes B1 <span class="token operator">+</span>Bytes B2<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><code>CONCAT</code> over lists of bytes is somewhat more involved, since we need to
distinguish this case from lists of strings.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CONCAT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span><span class="token punctuation">(</span>list bytes<span class="token punctuation">)</span> L<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>bytes #ConcatBytes<span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token punctuation">.</span>Bytes<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Bytes <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #ConcatBytes<span class="token punctuation">(</span>InternalList<span class="token punctuation">,</span> Bytes<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">// ----------------------------------------------------------</span>
  <span class="token keyword">rule</span> #ConcatBytes<span class="token punctuation">(</span><span class="token punctuation">.</span>InternalList<span class="token punctuation">,</span> A<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> A
  <span class="token keyword">rule</span> #ConcatBytes<span class="token punctuation">(</span><span class="token punctuation">[</span> B <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> DL<span class="token punctuation">,</span>   A<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #ConcatBytes<span class="token punctuation">(</span>DL<span class="token punctuation">,</span> A <span class="token operator">+</span>Bytes B<span class="token punctuation">)</span>
</code></pre>
<p><code>SIZE</code> is relatively simple, except that we must remember to divide by two,
since bytes length is measured in terms of number of bytes, not characters in
the hex string.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SIZE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>bytes B<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>nat lengthBytes<span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>The remaining operations are defined in terms of the same operations on
strings, allowing for code reuse.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SLICE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>nat O<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>nat L<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>bytes B<span class="token punctuation">:</span>Bytes<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option bytes #SliceBytes<span class="token punctuation">(</span>B<span class="token punctuation">,</span> O<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> OptionData <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #SliceBytes<span class="token punctuation">(</span>Bytes<span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">// ----------------------------------------------------------</span>
  <span class="token keyword">rule</span> #SliceBytes<span class="token punctuation">(</span>S<span class="token punctuation">,</span> O<span class="token punctuation">,</span> L<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Some substrBytes<span class="token punctuation">(</span>S<span class="token punctuation">,</span> O<span class="token punctuation">,</span> O <span class="token operator">+</span><span class="token keyword">Int</span> L<span class="token punctuation">)</span>
    <span class="token keyword">requires</span> O <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
     andBool L <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
     andBool O &lt;<span class="token keyword">Int</span> lengthBytes<span class="token punctuation">(</span>S<span class="token punctuation">)</span>
     andBool <span class="token punctuation">(</span>O <span class="token operator">+</span><span class="token keyword">Int</span> L<span class="token punctuation">)</span> <span class="token operator">&lt;=</span><span class="token keyword">Int</span> lengthBytes<span class="token punctuation">(</span>S<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #SliceBytes<span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> None <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>
</code></pre>
<h3 id="pair-operations">Pair Operations</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> PAIR A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>LTy L<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>RTy R<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>pair LTy RTy Pair L R<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> UNPAIR A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>pair LTy RTy Pair L R<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>LTy L<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>RTy R<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CAR A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>pair LTy _ Pair L _<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>LTy L<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CDR A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>pair _ RTy Pair _ R<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>RTy R<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="set-operations">Set Operations</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EMPTY_SET A T<span class="token punctuation">:</span>Type <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>set #Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token punctuation">.</span>Set<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> MEM A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>T X<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>set T S<span class="token punctuation">:</span>Set<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>bool X in S<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">// True to insert, False to remove.</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> UPDATE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>T D<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>bool <span class="token boolean">true</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>set T S<span class="token punctuation">:</span>Set<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>set T <span class="token punctuation">(</span>SetItem<span class="token punctuation">(</span>D<span class="token punctuation">)</span> S<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> UPDATE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>T D<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>bool <span class="token boolean">false</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>set T SetItem<span class="token punctuation">(</span>D<span class="token punctuation">)</span> S<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>set T S<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> UPDATE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>T D<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>bool <span class="token boolean">false</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>set T S<span class="token punctuation">:</span>Set<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>set T S<span class="token punctuation">:</span>Set<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token keyword">requires</span> notBool<span class="token punctuation">(</span>D in S<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SIZE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>set _ S<span class="token punctuation">:</span>Set<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>nat size<span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Note that, according to the Michelson documentation, set iteration order is
actually defined (the set is iterated over in ascending order).
For simplicity we implement this by repeatedly selecting the minimal element.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ITER A _ <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>set _ <span class="token punctuation">.</span>Set<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ITER A Body
        <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Body
        <span class="token operator">~&gt;</span> #Push<span class="token punctuation">(</span>set T<span class="token punctuation">,</span>S <span class="token operator">-</span>Set SetItem<span class="token punctuation">(</span>#MinimalElement<span class="token punctuation">(</span>Set2List<span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> ITER <span class="token punctuation">.</span>AnnotationList Body
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>set T S<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>T #MinimalElement<span class="token punctuation">(</span>Set2List<span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> size<span class="token punctuation">(</span>S<span class="token punctuation">)</span> &gt;<span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">syntax</span> Data <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #MinimalElement<span class="token punctuation">(</span>List<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">syntax</span> Data <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #MinimalElementAux<span class="token punctuation">(</span>List<span class="token punctuation">,</span> Data<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> #MinimalElement<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>H<span class="token punctuation">)</span> L<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #MinimalElementAux<span class="token punctuation">(</span>L<span class="token punctuation">,</span> H<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #MinimalElementAux<span class="token punctuation">(</span><span class="token punctuation">.</span>List<span class="token punctuation">,</span> M<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> M
  <span class="token keyword">rule</span> #MinimalElementAux<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>H<span class="token punctuation">)</span> L<span class="token punctuation">,</span> M<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> #MinimalElementAux<span class="token punctuation">(</span>L<span class="token punctuation">,</span> M<span class="token punctuation">)</span> <span class="token keyword">requires</span> #DoCompare<span class="token punctuation">(</span>M<span class="token punctuation">,</span> H<span class="token punctuation">)</span> <span class="token operator">&lt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
  <span class="token keyword">rule</span> #MinimalElementAux<span class="token punctuation">(</span>ListItem<span class="token punctuation">(</span>H<span class="token punctuation">)</span> L<span class="token punctuation">,</span> M<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> #MinimalElementAux<span class="token punctuation">(</span>L<span class="token punctuation">,</span> H<span class="token punctuation">)</span> <span class="token keyword">requires</span> #DoCompare<span class="token punctuation">(</span>M<span class="token punctuation">,</span> H<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">Int</span> <span class="token number">1</span>
</code></pre>
<h3 id="shared-map%2Fbig-map-operations">Shared Map/Big Map Operations</h3>
<p>Internally, we represent <code>map</code>s and <code>big_map</code>s identically using K maps.
For this reason, many map operations share an identical representation upto
typing (shared operations use a generic <code>MapTypeName</code>).</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> GET A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>KT K<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>_<span class="token punctuation">:</span>MapTypeName KT VT M<span class="token punctuation">:</span>Map<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option VT #lookup<span class="token punctuation">(</span>M<span class="token punctuation">,</span> K<span class="token punctuation">,</span> VT<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>KT<span class="token punctuation">,</span> K<span class="token punctuation">)</span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> OptionData <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #lookup<span class="token punctuation">(</span>Map<span class="token punctuation">,</span> Data<span class="token punctuation">,</span> TypeName<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> smtlib<span class="token punctuation">(</span>lookup<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token comment">// --------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #lookup<span class="token punctuation">(</span>M<span class="token punctuation">,</span> K<span class="token punctuation">,</span> VT<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Some <span class="token punctuation">{</span>M<span class="token punctuation">[</span>K<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">:</span>&gt;Data <span class="token keyword">requires</span> K in_keys<span class="token punctuation">(</span>M<span class="token punctuation">)</span> andBool         isValue<span class="token punctuation">(</span>VT<span class="token punctuation">,</span><span class="token punctuation">{</span>M<span class="token punctuation">[</span>K<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">:</span>&gt;Data<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #lookup<span class="token punctuation">(</span>M<span class="token punctuation">,</span> K<span class="token punctuation">,</span> _ <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> None              <span class="token keyword">requires</span> notBool K in_keys<span class="token punctuation">(</span>M<span class="token punctuation">)</span>
</code></pre>
<p>This rule is not supported by the LLVM backend, so we only include it in Haskell builds.</p>
<pre class="language-text"><code>  rule #lookup(M, K, VT) =&gt; #Bottom           requires K in_keys(M) andBool notBool isValue(VT,{M[K]}:&gt;Data)
</code></pre>
<pre class="language-text"><code>  rule #lookup(M [ K1 &lt;- V1    ], K2, VT) =&gt; Some {V1}:&gt;Data    requires K1 ==K  K2 andBool         isValue(VT,{V1}:&gt;Data) [simplification]
  rule #lookup(M [ K1 &lt;- V1    ], K2, VT) =&gt; #Bottom            requires K1 ==K  K2 andBool notBool isValue(VT,{V1}:&gt;Data) [simplification]
  rule #lookup(M [ K1 &lt;- undef ], K2, _ ) =&gt; None               requires K1 ==K  K2                                        [simplification]
  rule #lookup(M [ K1 &lt;- _     ], K2, VT) =&gt; #lookup(M, K2, VT) requires K1 =/=K K2                                        [simplification]
  rule #lookup(M [ K1 &lt;- undef ], K2, VT) =&gt; #lookup(M, K2, VT) requires K1 =/=K K2                                        [simplification]
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> MEM A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> #Assume<span class="token punctuation">(</span>isValue<span class="token punctuation">(</span>VT<span class="token punctuation">,</span> <span class="token punctuation">{</span>M<span class="token punctuation">[</span>K<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">:</span>&gt;Data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>KT K<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>_<span class="token punctuation">:</span>MapTypeName KT VT M<span class="token punctuation">:</span>Map<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>bool <span class="token boolean">true</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>KT<span class="token punctuation">,</span> K<span class="token punctuation">)</span>
     andBool K in_keys<span class="token punctuation">(</span>M<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> MEM A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>KT K<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>_<span class="token punctuation">:</span>MapTypeName KT _ M<span class="token punctuation">:</span>Map<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>bool <span class="token boolean">false</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> notBool K in_keys<span class="token punctuation">(</span>M<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> UPDATE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>KT K<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>option VT Some V<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>MT<span class="token punctuation">:</span>MapTypeName KT VT M<span class="token punctuation">:</span>Map<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>MT KT VT M<span class="token punctuation">[</span>K &lt;<span class="token operator">-</span> V<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>KT<span class="token punctuation">,</span> K<span class="token punctuation">)</span>
     andBool isValue<span class="token punctuation">(</span>VT<span class="token punctuation">,</span> V<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> UPDATE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>KT K<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>option VT None<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>MT<span class="token punctuation">:</span>MapTypeName KT VT M<span class="token punctuation">:</span>Map<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>MT KT VT M<span class="token punctuation">[</span>K &lt;<span class="token operator">-</span> undef<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="map-specific-operations">Map Specific Operations</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EMPTY_MAP A KT VT <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>#Name<span class="token punctuation">(</span>map A KT VT<span class="token punctuation">)</span> <span class="token punctuation">.</span>Map<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SIZE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>map _ _ M<span class="token punctuation">:</span>Map<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>nat size<span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>The <code>MAP</code> operation over maps is defined via psuedoinstruction <code>#DoMap</code>.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> MAP A Body
        <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> #DoMap<span class="token punctuation">(</span>#MapOpInfo<span class="token punctuation">(</span>KT<span class="token punctuation">,</span> VT<span class="token punctuation">,</span> NoneType<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">,</span> Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>map KT VT M<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><code>#DoMap</code> takes a <code>MapOpInfo</code> struct that holds the original map and newly built
map, as well as typing information. The map instruction proceeds as follows.
Let the map have <code>p</code> entries in sorted order:</p>
<pre class="language-text"><code>{ Elt key&#x2081; val&#x2081; ; Elt key&#x2082; val&#x2082; ; ... ; Elt key&#x209A; val&#x209A; }
</code></pre>
<p>We apply the map <code>code</code>, replacing the map on top of the stack with each
map entry in sorted order, and then build the new map by pairing each key
with the corresponding <code>code</code> generated value (with a possibly new type),
as described by the <code>MAP</code> typing rule below.</p>
<pre class="language-text"><code>          &#x393; &#x22A2; code :: ( pair key_ty val_ty1 ) : A &#x21D2; val_ty2 : A
:------------------------------------------------------------------------
      &#x393; &#x22A2; MAP code :: map key_ty val_ty1 : A &#x21D2; map key_ty val_ty2 : A
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> MapOpInfo <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #MapOpInfo<span class="token punctuation">(</span>keyType     <span class="token punctuation">:</span>TypeName<span class="token punctuation">,</span>
                                  origValType <span class="token punctuation">:</span>TypeName<span class="token punctuation">,</span>
                                  newValType  <span class="token punctuation">:</span>MaybeTypeName<span class="token punctuation">,</span>
                                  origMap     <span class="token punctuation">:</span>Map<span class="token punctuation">,</span>
                                  newMap      <span class="token punctuation">:</span>Map<span class="token punctuation">,</span>
                                  mapBody     <span class="token punctuation">:</span>Block<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #DoMap<span class="token punctuation">(</span>MapOpInfo<span class="token punctuation">)</span>
  <span class="token comment">// -------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #DoMap<span class="token punctuation">(</span>#MapOpInfo<span class="token punctuation">(</span>KT<span class="token punctuation">,</span> VT<span class="token punctuation">,</span> NVT<span class="token punctuation">,</span> M1<span class="token punctuation">,</span> M2<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> B
        <span class="token operator">~&gt;</span> #DoMapAux<span class="token punctuation">(</span>#MinKey<span class="token punctuation">(</span>M1<span class="token punctuation">)</span><span class="token punctuation">,</span>
                     #MapOpInfo<span class="token punctuation">(</span>KT<span class="token punctuation">,</span> VT<span class="token punctuation">,</span> NVT<span class="token punctuation">,</span> M1<span class="token punctuation">[</span>#MinKey<span class="token punctuation">(</span>M1<span class="token punctuation">)</span> &lt;<span class="token operator">-</span> undef<span class="token punctuation">]</span><span class="token punctuation">,</span> M2<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>pair KT VT Pair #MinKey<span class="token punctuation">(</span>M1<span class="token punctuation">)</span> <span class="token punctuation">{</span>M1<span class="token punctuation">[</span>#MinKey<span class="token punctuation">(</span>M1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">:</span>&gt;Data<span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> size<span class="token punctuation">(</span>M1<span class="token punctuation">)</span> &gt;<span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #DoMap<span class="token punctuation">(</span>#MapOpInfo<span class="token punctuation">(</span>KT<span class="token punctuation">,</span> VT<span class="token punctuation">,</span> NVT<span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">,</span> M<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>map KT #DefaultType<span class="token punctuation">(</span>NVT<span class="token punctuation">,</span>VT<span class="token punctuation">)</span> M<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #DoMapAux<span class="token punctuation">(</span>Data<span class="token punctuation">,</span> MapOpInfo<span class="token punctuation">)</span>
  <span class="token comment">// ----------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #DoMapAux<span class="token punctuation">(</span>K<span class="token punctuation">,</span> #MapOpInfo<span class="token punctuation">(</span>KT<span class="token punctuation">,</span> VT<span class="token punctuation">,</span> NVT<span class="token punctuation">,</span> M1<span class="token punctuation">,</span> M2<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> #DoMap<span class="token punctuation">(</span>#MapOpInfo<span class="token punctuation">(</span>KT<span class="token punctuation">,</span> VT<span class="token punctuation">,</span> NVT&apos;<span class="token punctuation">,</span> M1<span class="token punctuation">,</span> M2<span class="token punctuation">[</span>K &lt;<span class="token operator">-</span> V<span class="token punctuation">]</span><span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>NVT&apos; V<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> #CompatibleTypes<span class="token punctuation">(</span>NVT<span class="token punctuation">,</span>NVT&apos;<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> Data <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #MinKey<span class="token punctuation">(</span>Map<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">// ------------------------------------</span>
  <span class="token keyword">rule</span> #MinKey<span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #MinimalElement<span class="token punctuation">(</span>keys_list<span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>We define auxiliary functions for computing the result type of <code>MAP</code>.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> MaybeTypeName <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> TypeName
                         <span class="token operator">|</span> <span class="token string">&quot;NoneType&quot;</span>

  <span class="token keyword">syntax</span> <span class="token keyword">Bool</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #CompatibleTypes<span class="token punctuation">(</span>MaybeTypeName<span class="token punctuation">,</span> TypeName<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">// -----------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #CompatibleTypes<span class="token punctuation">(</span>NoneType<span class="token punctuation">,</span>    _ <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #CompatibleTypes<span class="token punctuation">(</span>T1<span class="token punctuation">:</span>TypeName<span class="token punctuation">,</span> T2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> T1 <span class="token operator">==</span>K T2

  <span class="token keyword">syntax</span> TypeName <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #DefaultType<span class="token punctuation">(</span>MaybeTypeName<span class="token punctuation">,</span> TypeName<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">// -----------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #DefaultType<span class="token punctuation">(</span>T<span class="token punctuation">:</span>TypeName<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> T
  <span class="token keyword">rule</span> #DefaultType<span class="token punctuation">(</span>NoneType<span class="token punctuation">,</span> T<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> T
</code></pre>
<p><code>ITER</code> is relatively easy to implement using a straightforward recursive style,
since it does not need to track the new map while keeping it off the stack.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ITER A _ <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>map _ _ <span class="token punctuation">.</span>Map<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ITER A Body
        <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Body
        <span class="token operator">~&gt;</span> #Push<span class="token punctuation">(</span>map KT VT<span class="token punctuation">,</span> M<span class="token punctuation">[</span>#MinKey<span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>-</span> <span class="token attr-name">undef])</span>
        <span class="token attr-name">~</span><span class="token punctuation">&gt;</span></span> ITER <span class="token punctuation">.</span>AnnotationList Body
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>map KT VT M<span class="token punctuation">:</span>Map<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>pair KT VT Pair #MinKey<span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token punctuation">{</span>M<span class="token punctuation">[</span>#MinKey<span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">:</span>&gt;Data<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> size<span class="token punctuation">(</span>M<span class="token punctuation">)</span> &gt;<span class="token keyword">Int</span> <span class="token number">0</span>
</code></pre>
<h3 id="big-map-specific-operations">Big Map Specific Operations</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EMPTY_BIG_MAP A KT VT <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>#Name<span class="token punctuation">(</span>big_map A KT VT<span class="token punctuation">)</span> <span class="token punctuation">.</span>Map<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="option-operations">Option Operations</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SOME A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>T X<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option T Some X<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> NONE A T<span class="token punctuation">:</span>Type <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option #Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span> None<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IF_NONE A BT _  <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> BT <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>option _ None<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IF_NONE A _  BF <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> BF <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>option T Some V<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>T V<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="union-operations">Union Operations</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> LEFT A RTy<span class="token punctuation">:</span>Type <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>LTy X<span class="token punctuation">:</span>Data<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>or LTy #Name<span class="token punctuation">(</span>RTy<span class="token punctuation">)</span> Left X<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> RIGHT A LTy<span class="token punctuation">:</span>Type <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>RTy X<span class="token punctuation">:</span>Data<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>or #Name<span class="token punctuation">(</span>LTy<span class="token punctuation">)</span> RTy Right X<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IF_LEFT A BT _  <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> BT <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>or LTy _   Left V<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>LTy V<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IF_LEFT A _  BF <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> BF <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>or _   RTy Right V<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>RTy V<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="list-operations">List Operations</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CONS A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>T V<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>list T L<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>list T <span class="token punctuation">[</span> V <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> L<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> NIL A T <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>list #Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token punctuation">.</span>InternalList<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IF_CONS A BT _  <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> BT <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>list T <span class="token punctuation">[</span> E <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> L<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>T E<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>list T L<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IF_CONS A _  BF <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> BF <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>list _ <span class="token punctuation">.</span>InternalList <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SIZE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>list _ L<span class="token punctuation">:</span>InternalList<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>nat size<span class="token punctuation">(</span>L<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ITER A _ <span class="token operator">=&gt;</span>  #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">~&gt;</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>list _ <span class="token punctuation">.</span>InternalList<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ITER A Body
        <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Body
        <span class="token operator">~&gt;</span> #Push<span class="token punctuation">(</span>list T<span class="token punctuation">,</span>L<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> ITER <span class="token punctuation">.</span>AnnotationList Body
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>list T <span class="token punctuation">[</span> E <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> L<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>T E<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>The <code>MAP</code> operation over <code>list</code>s is defined in terms of a helper function.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> MAP A Body
        <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> #DoMap<span class="token punctuation">(</span>T<span class="token punctuation">,</span> NoneType<span class="token punctuation">,</span> L<span class="token punctuation">,</span> <span class="token punctuation">.</span>InternalList<span class="token punctuation">,</span> Body<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>list T L<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #DoMap<span class="token punctuation">(</span>TypeName<span class="token punctuation">,</span> MaybeTypeName<span class="token punctuation">,</span> InternalList<span class="token punctuation">,</span> InternalList<span class="token punctuation">,</span> Block<span class="token punctuation">)</span>
                       <span class="token operator">|</span> #DoMapAux<span class="token punctuation">(</span>TypeName<span class="token punctuation">,</span> MaybeTypeName<span class="token punctuation">,</span> InternalList<span class="token punctuation">,</span> InternalList<span class="token punctuation">,</span> Block<span class="token punctuation">)</span>
  <span class="token comment">// -----------------------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #DoMap<span class="token punctuation">(</span>T<span class="token punctuation">,</span> NT<span class="token punctuation">,</span> <span class="token punctuation">.</span>InternalList<span class="token punctuation">,</span> Acc<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>list #DefaultType<span class="token punctuation">(</span>NT<span class="token punctuation">,</span>T<span class="token punctuation">)</span> #ReverseList<span class="token punctuation">(</span>Acc<span class="token punctuation">,</span> <span class="token punctuation">.</span>InternalList<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #DoMap<span class="token punctuation">(</span>T<span class="token punctuation">,</span> NT<span class="token punctuation">,</span> <span class="token punctuation">[</span> E <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> L<span class="token punctuation">,</span> Acc<span class="token punctuation">,</span> B<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> B
        <span class="token operator">~&gt;</span> #DoMapAux<span class="token punctuation">(</span>T<span class="token punctuation">,</span> NT<span class="token punctuation">,</span> L<span class="token punctuation">,</span> Acc<span class="token punctuation">,</span> B<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>T E<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #DoMapAux<span class="token punctuation">(</span>T<span class="token punctuation">,</span> NT<span class="token punctuation">,</span> L<span class="token punctuation">,</span> Acc<span class="token punctuation">,</span> B<span class="token punctuation">)</span>
        <span class="token operator">=&gt;</span> #DoMap<span class="token punctuation">(</span>T<span class="token punctuation">,</span> NT&apos;<span class="token punctuation">,</span> L<span class="token punctuation">,</span> <span class="token punctuation">[</span> E <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> Acc<span class="token punctuation">,</span> B<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>NT&apos; E<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> #CompatibleTypes<span class="token punctuation">(</span>NT<span class="token punctuation">,</span>NT&apos;<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> InternalList <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #ReverseList<span class="token punctuation">(</span>InternalList<span class="token punctuation">,</span> InternalList<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
  <span class="token comment">// ------------------------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #ReverseList<span class="token punctuation">(</span>E <span class="token punctuation">;</span><span class="token punctuation">;</span> L<span class="token punctuation">,</span>        L<span class="token string">&apos;) =&gt; #ReverseList(L, E ;; L&apos;</span><span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #ReverseList<span class="token punctuation">(</span><span class="token punctuation">.</span>InternalList<span class="token punctuation">,</span> L<span class="token string">&apos;) =&gt; L&apos;</span>
</code></pre>
<h2 id="domain-specific-operations">Domain Specific operations</h2>
<h3 id="timestamp-operations">Timestamp Operations</h3>
<p>Timestamps are simply wrapped ints in Michelson, so the implementation of
simple arithmetic over them is straightforward. The differing argument types
however forces us to use two rules for each operation.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ADD A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>timestamp #Timestamp<span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>int I2<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>timestamp #Timestamp<span class="token punctuation">(</span>I1 <span class="token operator">+</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ADD A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>int I1<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>timestamp #Timestamp<span class="token punctuation">(</span>I2<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>timestamp #Timestamp<span class="token punctuation">(</span>I1 <span class="token operator">+</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SUB A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>timestamp #Timestamp<span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>int I2<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>timestamp #Timestamp<span class="token punctuation">(</span>I1 <span class="token operator">-</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SUB A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>timestamp #Timestamp<span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>timestamp #Timestamp<span class="token punctuation">(</span>I2<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>int I1 <span class="token operator">-</span><span class="token keyword">Int</span> I2<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="blockchain-operations">Blockchain Operations</h3>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CREATE_CONTRACT A<span class="token punctuation">:</span>AnnotationList <span class="token punctuation">{</span> C <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>option key_hash Delegate<span class="token punctuation">:</span>OptionData<span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span>mutez Initial<span class="token punctuation">:</span>Mutez<span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span>_ Storage<span class="token punctuation">:</span>Data<span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>operation Create_contract <span class="token punctuation">{</span> C <span class="token punctuation">}</span> Delegate Initial Storage O <span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span>address #Address<span class="token punctuation">(</span><span class="token string">&quot;@Address(&quot;</span> <span class="token operator">+</span><span class="token keyword">String</span> Int2String<span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token keyword">String</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonce</span><span class="token punctuation">&gt;</span></span> #Nonce<span class="token punctuation">(</span>O<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #NextNonce<span class="token punctuation">(</span>#Nonce<span class="token punctuation">(</span>O<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonce</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> TRANSFER_TOKENS AL <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>AL<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>T D<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>mutez M<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>contract T #Contract<span class="token punctuation">(</span>A<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>operation Transfer_tokens D M A O<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonce</span><span class="token punctuation">&gt;</span></span> #Nonce<span class="token punctuation">(</span>O<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #NextNonce<span class="token punctuation">(</span>#Nonce<span class="token punctuation">(</span>O<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonce</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SET_DELEGATE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>option key_hash D<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>operation Set_delegate D O<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonce</span><span class="token punctuation">&gt;</span></span> #Nonce<span class="token punctuation">(</span>O<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #NextNonce<span class="token punctuation">(</span>#Nonce<span class="token punctuation">(</span>O<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonce</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Each <code>operation</code> value must have a unique nonce.
The nonce generation process is unspecified by the Michelson semantics.
We implement it here.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> OperationNonce <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #NextNonce<span class="token punctuation">(</span>OperationNonce<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> #NextNonce<span class="token punctuation">(</span>#Nonce<span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #Nonce<span class="token punctuation">(</span>I <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
<p>These instructions push fresh <code>contract</code> literals on the stack corresponding
to the given addresses/key hashes.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CONTRACT AL T <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>AL<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>address A<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option contract #Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span> Some <span class="token punctuation">{</span>M<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">:</span>&gt;Data<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>knownaddrs</span><span class="token punctuation">&gt;</span></span> M <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>knownaddrs</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> A in_keys<span class="token punctuation">(</span>M<span class="token punctuation">)</span>
     andBool #TypeFromContractStruct<span class="token punctuation">(</span><span class="token punctuation">{</span>M<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">:</span>&gt;Data<span class="token punctuation">)</span> <span class="token operator">==</span>K T

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CONTRACT AL T <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>AL<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>address _<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option contract #Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span> None<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>knownaddrs</span><span class="token punctuation">&gt;</span></span> _ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>knownaddrs</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IMPLICIT_ACCOUNT AL <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>AL<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>key_hash #KeyHash<span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>contract unit #Contract<span class="token punctuation">(</span>#Address<span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">,</span> unit <span class="token punctuation">.</span>AnnotationList<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> Type <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #TypeFromContractStruct<span class="token punctuation">(</span>Data<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> #TypeFromContractStruct<span class="token punctuation">(</span>#Contract<span class="token punctuation">(</span>_<span class="token punctuation">,</span> T<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> T
</code></pre>
<p>These instructions push blockchain state on the stack.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> BALANCE A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>mutez B<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mybalance</span><span class="token punctuation">&gt;</span></span> B <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mybalance</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ADDRESS AL <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>AL<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>contract TN #Contract<span class="token punctuation">(</span>A<span class="token punctuation">,</span> T<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>address A<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> TN <span class="token operator">==</span>K #Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SOURCE AL <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>AL<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>address A<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sourceaddr</span><span class="token punctuation">&gt;</span></span> A <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sourceaddr</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SENDER AL <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>AL<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>address A<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>senderaddr</span><span class="token punctuation">&gt;</span></span> A <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>senderaddr</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SELF AL <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>AL<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>contract #Name<span class="token punctuation">(</span>T<span class="token punctuation">)</span> #Contract<span class="token punctuation">(</span>A<span class="token punctuation">,</span> T<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>paramtype</span><span class="token punctuation">&gt;</span></span> T <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>paramtype</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>myaddr</span><span class="token punctuation">&gt;</span></span> A <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>myaddr</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> AMOUNT A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>mutez M<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>myamount</span><span class="token punctuation">&gt;</span></span> M <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>myamount</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CHAIN_ID A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>chain_id C<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mychainid</span><span class="token punctuation">&gt;</span></span> C <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mychainid</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> NOW A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>timestamp N<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mynow</span><span class="token punctuation">&gt;</span></span> N <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mynow</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3 id="cryptographic-operations">Cryptographic Operations</h3>
<p>The cryptographic operations are simply stubbed for now.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> <span class="token keyword">String</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #Blake2BKeyHash<span class="token punctuation">(</span><span class="token keyword">String</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> #Blake2BKeyHash<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> S

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> HASH_KEY A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>key #Key<span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>key_hash #KeyHash<span class="token punctuation">(</span>#Blake2BKeyHash<span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> BLAKE2B A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>bytes B<span class="token punctuation">:</span>MichelsonBytes<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>bytes #Blake2B<span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SHA256 A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>bytes B<span class="token punctuation">:</span>MichelsonBytes<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>bytes #SHA256<span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SHA512 A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>bytes B<span class="token punctuation">:</span>MichelsonBytes<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>bytes #SHA512<span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">syntax</span> MichelsonBytes <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #SignBytes<span class="token punctuation">(</span>Key<span class="token punctuation">,</span> Signature<span class="token punctuation">,</span> MichelsonBytes<span class="token punctuation">)</span>

  <span class="token comment">/*
  // FIXME: The haskell backend does not support distinguishing these rules.
  rule &lt;k&gt; CHECK_SIGNATURE A =&gt; #HandleAnnotations(A) ... &lt;/k&gt;
       &lt;stack&gt; #Key(K)
            ~&gt; #Signature(S)
            ~&gt; #SignBytes(#Key(K), #Signature(S), _)
            =&gt; true
               ...
       &lt;/stack&gt;

  rule &lt;k&gt; CHECK_SIGNATURE A =&gt; #HandleAnnotations(A) ... &lt;/k&gt;
       &lt;stack&gt; #Key(_)
            ~&gt; #Signature(_)
            ~&gt; _:MichelsonBytes
            =&gt; false
               ...
       &lt;/stack&gt; [owise]
  */</span>
</code></pre>
<h3 id="mutez-operations">Mutez Operations</h3>
<p>Mutez operations need to check their results since <code>mutez</code> is not an unlimited
precision type.
This internal instruction checks and produces the appropriate error case if the
value is invalid.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #ValidateMutezAndPush<span class="token punctuation">(</span>Mutez<span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span>
  <span class="token comment">// ----------------------------------------------------------</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #ValidateMutezAndPush<span class="token punctuation">(</span>#Mutez<span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
       <span class="token keyword">requires</span> #IsLegalMutezValue<span class="token punctuation">(</span>I<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #ValidateMutezAndPush<span class="token punctuation">(</span>#Mutez<span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">,</span> I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> Rk
        <span class="token operator">=&gt;</span> Aborted<span class="token punctuation">(</span><span class="token string">&quot;Mutez out of bounds&quot;</span><span class="token punctuation">,</span> I<span class="token punctuation">,</span> Rk<span class="token punctuation">,</span> Rs<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> Rk <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> Rs <span class="token operator">=&gt;</span> #FailureFromMutezValue<span class="token punctuation">(</span>#Mutez<span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">,</span> I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> notBool #IsLegalMutezValue<span class="token punctuation">(</span>I<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> FailedStack <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #FailureFromMutezValue<span class="token punctuation">(</span>Mutez<span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">// ----------------------------------------------------------------------</span>
  <span class="token keyword">rule</span> #FailureFromMutezValue<span class="token punctuation">(</span>#Mutez<span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">,</span> I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> <span class="token punctuation">(</span> MutezOverflow I1 I2 <span class="token punctuation">)</span> <span class="token keyword">requires</span> I <span class="token operator">&gt;=</span><span class="token keyword">Int</span> #MutezOverflowLimit
  <span class="token keyword">rule</span> #FailureFromMutezValue<span class="token punctuation">(</span>#Mutez<span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">,</span> I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> <span class="token punctuation">(</span> MutezUnderflow I1 I2 <span class="token punctuation">)</span> <span class="token keyword">requires</span> I &lt;<span class="token keyword">Int</span> <span class="token number">0</span>
</code></pre>
<p>Other than the mutez validation step, these arithmetic rules are essentially
identical to those defined over integers.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ADD A
        <span class="token operator">=&gt;</span> #ValidateMutezAndPush<span class="token punctuation">(</span>#Mutez<span class="token punctuation">(</span>I1 <span class="token operator">+</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span><span class="token punctuation">,</span> I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>I2<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SUB A
        <span class="token operator">=&gt;</span> #ValidateMutezAndPush<span class="token punctuation">(</span>#Mutez<span class="token punctuation">(</span>I1 <span class="token operator">-</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span><span class="token punctuation">,</span> I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>I2<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> MUL A
        <span class="token operator">=&gt;</span> #ValidateMutezAndPush<span class="token punctuation">(</span>#Mutez<span class="token punctuation">(</span>I1 <span class="token operator">*</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span><span class="token punctuation">,</span> I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>nat I2<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> MUL A
        <span class="token operator">=&gt;</span> #ValidateMutezAndPush<span class="token punctuation">(</span>#Mutez<span class="token punctuation">(</span>I1 <span class="token operator">*</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span><span class="token punctuation">,</span> I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>nat I1<span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>I2<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EDIV A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option pair nat mutez None<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EDIV A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token punctuation">[</span>nat <span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option pair mutez mutez None<span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EDIV A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>I2<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option pair nat mutez Some <span class="token punctuation">(</span>Pair <span class="token punctuation">(</span>I1 <span class="token operator">/</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span> #Mutez<span class="token punctuation">(</span>I1 <span class="token operator">%</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> I2 &gt;<span class="token keyword">Int</span> <span class="token number">0</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> EDIV A <span class="token operator">=&gt;</span> #HandleAnnotations<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>mutez #Mutez<span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>
               <span class="token punctuation">[</span>nat I2<span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
            <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>option pair mutez mutez Some <span class="token punctuation">(</span>Pair #Mutez<span class="token punctuation">(</span>I1 <span class="token operator">/</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span> #Mutez<span class="token punctuation">(</span>I1 <span class="token operator">%</span><span class="token keyword">Int</span> I2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>
               SS
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> I2 &gt;<span class="token keyword">Int</span> <span class="token number">0</span>
</code></pre>
<h2 id="debugging-operations">Debugging Operations</h2>
<p>We introduce several pseudo-instructions that are used for debugging:</p>
<ul>
<li><code>STOP</code> is an instruction that cannot be evaluated and causes the program to
get stuck</li>
<li><code>PAUSE</code> non-determinstically chooses to either do nothing or else <code>STOP</code>;
it optionally traces at its pause point.</li>
<li><code>TRACE</code> appends its string content to the <code>&lt;trace&gt;</code> cell as a debugging aid
for complex programs.</li>
</ul>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> PAUSE    <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> PAUSE    <span class="token operator">=&gt;</span> STOP              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> PAUSE<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> TRACE<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">~&gt;</span> PAUSE <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> TRACE<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trace</span><span class="token punctuation">&gt;</span></span> K<span class="token punctuation">:</span>K <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>K <span class="token operator">~&gt;</span> S<span class="token punctuation">)</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trace</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h2 id="internal-operations">Internal Operations</h2>
<p>These operations are used internally for implementation purposes.</p>
<h3 id="assume%2Fassert-instructions"><code>ASSUME</code>/<code>ASSERT</code> Instructions</h3>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;ASSERT&quot;</span> <span class="token string">&quot;{&quot;</span> BlockList <span class="token string">&quot;}&quot;</span>
                       <span class="token operator">|</span> <span class="token string">&quot;ASSUME&quot;</span> <span class="token string">&quot;{&quot;</span> BlockList <span class="token string">&quot;}&quot;</span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT <span class="token punctuation">{</span> <span class="token punctuation">.</span>BlockList <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT <span class="token punctuation">{</span> B<span class="token punctuation">;</span> Bs <span class="token punctuation">}</span>
        <span class="token operator">=&gt;</span> B <span class="token operator">~&gt;</span> #AssertTrue <span class="token operator">~&gt;</span> ASSERT <span class="token punctuation">{</span> Bs <span class="token punctuation">}</span> <span class="token operator">~&gt;</span> #RestoreStack<span class="token punctuation">(</span>SS<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Stack <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSUME <span class="token punctuation">{</span> <span class="token punctuation">.</span>BlockList <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSUME <span class="token punctuation">{</span> B<span class="token punctuation">;</span> Bs <span class="token punctuation">}</span>
        <span class="token operator">=&gt;</span> B <span class="token operator">~&gt;</span> #AssumeTrue <span class="token operator">~&gt;</span> ASSUME <span class="token punctuation">{</span> Bs <span class="token punctuation">}</span> <span class="token operator">~&gt;</span> #RestoreStack<span class="token punctuation">(</span>SS<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> SS <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>Stack <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #RestoreStack<span class="token punctuation">(</span>K<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #RestoreStack<span class="token punctuation">(</span>SS<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#AssertTrue&quot;</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #AssertTrue <span class="token operator">=&gt;</span> #Assert<span class="token punctuation">(</span>B<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>bool B<span class="token punctuation">:</span><span class="token keyword">Bool</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#AssumeTrue&quot;</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #AssumeTrue <span class="token operator">=&gt;</span> #Assume<span class="token punctuation">(</span>B<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>bool B<span class="token punctuation">:</span><span class="token keyword">Bool</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> SS <span class="token operator">=&gt;</span> SS <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #Assert<span class="token punctuation">(</span>BoolExp<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> result<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Assert<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Assert<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #AssertFailed <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#AssertFailed&quot;</span> <span class="token punctuation">[</span><span class="token class-name">klabel</span><span class="token punctuation">(</span>#AssertFailed<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">symbol</span><span class="token punctuation">]</span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #Assume<span class="token punctuation">(</span>BoolExp<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">strict</span><span class="token punctuation">,</span> result<span class="token punctuation">(</span><span class="token keyword">Bool</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Assume<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Assume<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">~&gt;</span> _<span class="token punctuation">:</span>K <span class="token operator">=&gt;</span> <span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>assumeFailed</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> <span class="token boolean">true</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>assumeFailed</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span>transition<span class="token punctuation">]</span>
</code></pre>
<p>Note that the first value is a <code>KItem</code> and not heated/cooled. This is to work
around the need for sort coersion in the map <code>GET</code> operation.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> BoolExp <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token keyword">Bool</span>
                   <span class="token operator">|</span> KItem <span class="token string">&quot;==&quot;</span> Data

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> D1 <span class="token operator">==</span> D2 <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>D2 <span class="token operator">~&gt;</span> D1 <span class="token operator">==</span> #hole<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> notBool isValue<span class="token punctuation">(</span>D2<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>D2 <span class="token operator">~&gt;</span> D1 <span class="token operator">==</span> #hole<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> D1 <span class="token operator">==</span> D2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>D2<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> D1 <span class="token operator">==</span> D2 <span class="token operator">=&gt;</span> D1 <span class="token operator">==</span>K D2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>           <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>D2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> isBool<span class="token punctuation">(</span>_L <span class="token operator">==</span> _R<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span> <span class="token punctuation">[</span>simplification<span class="token punctuation">]</span>
</code></pre>
<h3 id="cutpoint-instruction"><code>CUTPOINT</code> Instruction</h3>
<p>A cutpoint is a semantic construct that internalizes the notion of a
reachability logic circularity (or claim).
When we reach a cutpoint, we need to generalize our current state into one
which corresponds to the reachability logic circularity that we wish to use.</p>
<pre class="language-text"><code>  syntax Instruction ::= CUTPOINT( id: Int, invariant: Invariant)

  rule &lt;k&gt; CUTPOINT(I, { Shape } { Predicates })
        =&gt; BIND { Shape } { ASSERT { Predicates }}
        ~&gt; #GeneralizeStack(Shape, .Stack)
        ~&gt; BIND { Shape } { ASSUME { Predicates }}
           ...
       &lt;/k&gt;
       &lt;cutpoints&gt; (.Set =&gt; SetItem(I)) VisitedCutpoints &lt;/cutpoints&gt;
    requires notBool I in VisitedCutpoints

  rule &lt;k&gt; CUTPOINT(I, { Shape } { Predicates })
        =&gt; BIND { Shape } { ASSERT { Predicates }}
        ~&gt; #Assume(false)
           ...
       &lt;/k&gt;
       &lt;cutpoints&gt; VisitedCutpoints &lt;/cutpoints&gt;
    requires I in VisitedCutpoints
</code></pre>
<p>In stack-based languages like Michelson, state generalization means that we
abstract out pieces of the stack which are non-invariant during loop execution.</p>
<pre class="language-text"><code>  syntax KItem ::= #GeneralizeStack(StackElementList, Stack)
  rule &lt;k&gt; #GeneralizeStack(.StackElementList, SS) =&gt; . ... &lt;/k&gt;
       &lt;stack&gt; _ =&gt; reverseStack( SS ) &lt;/stack&gt;

  rule &lt;k&gt; #GeneralizeStack(Stack_elt T D ; SS, SS&apos;)
        =&gt; #GeneralizeStack(SS, [#Name(T) D] ; SS&apos;)
           ...
       &lt;/k&gt;
    requires notBool isSymbolicData(D)

  rule &lt;k&gt; (.K =&gt; #MakeFresh(T))
        ~&gt; #GeneralizeStack(Stack_elt T D:SymbolicData ; SS, SS&apos;)
           ...
       &lt;/k&gt;

  rule &lt;k&gt; ( V
          ~&gt; #GeneralizeStack(Stack_elt T D:SymbolicData ; SS, SS&apos;)
           )
        =&gt;   #GeneralizeStack(Stack_elt T V ; SS, SS&apos;)
           ...
       &lt;/k&gt;
    requires isValue(#Name(T),V)
</code></pre>
<h3 id="bind-instruction"><code>BIND</code> Instruction</h3>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> Instruction <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;BIND&quot;</span> OutputStack Block
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> BIND Shape Block
        <span class="token operator">=&gt;</span> #Bind<span class="token punctuation">(</span>#LiteralStackToStack<span class="token punctuation">(</span>Shape<span class="token punctuation">)</span><span class="token punctuation">,</span> Stack<span class="token punctuation">)</span>
        <span class="token operator">~&gt;</span> Block
        <span class="token operator">~&gt;</span> #RestoreSymbols<span class="token punctuation">(</span>Symbols<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>symbols</span><span class="token punctuation">&gt;</span></span> Symbols <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>symbols</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>stack</span><span class="token punctuation">&gt;</span></span> Stack <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>stack</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #Bind<span class="token punctuation">(</span>InternalStack<span class="token punctuation">,</span> InternalStack<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Bind<span class="token punctuation">(</span><span class="token punctuation">.</span>Stack<span class="token punctuation">,</span> <span class="token punctuation">.</span>Stack<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Bind<span class="token punctuation">(</span>S1<span class="token punctuation">:</span>FailedStack<span class="token punctuation">,</span> S2<span class="token punctuation">:</span>FailedStack<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> #Matches<span class="token punctuation">(</span>S1<span class="token punctuation">,</span> S2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Bind<span class="token punctuation">(</span> <span class="token punctuation">[</span> T S<span class="token punctuation">:</span>SymbolicData <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS  <span class="token operator">=&gt;</span> SS
                <span class="token punctuation">,</span> <span class="token punctuation">[</span> T D <span class="token punctuation">]</span>              <span class="token punctuation">;</span> SS<span class="token string">&apos; =&gt; SS&apos;</span>
                <span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>symbols</span><span class="token punctuation">&gt;</span></span> Syms <span class="token operator">=&gt;</span> S <span class="token operator">|</span><span class="token operator">-</span>&gt; #TypedSymbol<span class="token punctuation">(</span>T<span class="token punctuation">,</span> D<span class="token punctuation">)</span> Syms <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>symbols</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> notBool S in_keys<span class="token punctuation">(</span>Syms<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Bind<span class="token punctuation">(</span> <span class="token punctuation">[</span> T S<span class="token punctuation">:</span>SymbolicData <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS  <span class="token operator">=&gt;</span> SS
                <span class="token punctuation">,</span> <span class="token punctuation">[</span> T D1 <span class="token punctuation">]</span>             <span class="token punctuation">;</span> SS<span class="token string">&apos; =&gt; SS&apos;</span>
                <span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>symbols</span><span class="token punctuation">&gt;</span></span> S <span class="token operator">|</span><span class="token operator">-</span>&gt; #TypedSymbol<span class="token punctuation">(</span>T<span class="token punctuation">,</span> D2<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>symbols</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> D1 <span class="token operator">==</span>K D2

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #Bind<span class="token punctuation">(</span> <span class="token punctuation">[</span> T ED <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS  <span class="token operator">=&gt;</span> SS
                <span class="token punctuation">,</span> <span class="token punctuation">[</span> T AD <span class="token punctuation">]</span> <span class="token punctuation">;</span> SS<span class="token string">&apos; =&gt; SS&apos;</span>
                <span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>knownaddrs</span><span class="token punctuation">&gt;</span></span> KnownAddrs <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>knownaddrs</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bigmaps</span><span class="token punctuation">&gt;</span></span> BigMaps <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bigmaps</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> #ConcreteMatch<span class="token punctuation">(</span>ED<span class="token punctuation">,</span> #Type<span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span> KnownAddrs<span class="token punctuation">,</span> BigMaps<span class="token punctuation">,</span> AD<span class="token punctuation">)</span>

  <span class="token comment">// NOTE: this function protects against unification errors</span>
  <span class="token keyword">syntax</span> <span class="token keyword">Bool</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #ConcreteMatch<span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Type<span class="token punctuation">,</span> Map<span class="token punctuation">,</span> Map<span class="token punctuation">,</span> Data<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token keyword">rule</span> #ConcreteMatch<span class="token punctuation">(</span>_<span class="token punctuation">:</span>SymbolicData<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span>
  <span class="token keyword">rule</span> #ConcreteMatch<span class="token punctuation">(</span>ED<span class="token punctuation">,</span> T<span class="token punctuation">,</span> Addrs<span class="token punctuation">,</span> BigMaps<span class="token punctuation">,</span> AD<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>#MichelineToNative<span class="token punctuation">(</span>ED<span class="token punctuation">,</span>T<span class="token punctuation">,</span>Addrs<span class="token punctuation">,</span>BigMaps<span class="token punctuation">)</span><span class="token punctuation">,</span>AD<span class="token punctuation">)</span>
    <span class="token keyword">requires</span> notBool isSymbolicData<span class="token punctuation">(</span>ED<span class="token punctuation">)</span>
</code></pre>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> KItem <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #RestoreSymbols<span class="token punctuation">(</span>Map<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> #RestoreSymbols<span class="token punctuation">(</span>Symbols<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">.</span>K <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>symbols</span><span class="token punctuation">&gt;</span></span> _ <span class="token operator">=&gt;</span> Symbols <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>symbols</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h2 id="macro-evaluation">Macro Evaluation</h2>
<h3 id="simple-macro-evaluation">Simple Macro Evaluation</h3>
<p>The following macros have one-step mappings to Michelson code.</p>
<pre class="language-k"><code>  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CMPEQ _  <span class="token operator">=&gt;</span> COMPARE <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> EQ  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CMPNEQ _ <span class="token operator">=&gt;</span> COMPARE <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> NEQ <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CMPLT _  <span class="token operator">=&gt;</span> COMPARE <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> LT  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CMPGT _  <span class="token operator">=&gt;</span> COMPARE <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> GT  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CMPLE _  <span class="token operator">=&gt;</span> COMPARE <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> LE  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> CMPGE _  <span class="token operator">=&gt;</span> COMPARE <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> GE  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFEQ     _ B1 B2 <span class="token operator">=&gt;</span> EQ     <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFNEQ    _ B1 B2 <span class="token operator">=&gt;</span> NEQ    <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFLT     _ B1 B2 <span class="token operator">=&gt;</span> LT     <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFGT     _ B1 B2 <span class="token operator">=&gt;</span> GT     <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFLE     _ B1 B2 <span class="token operator">=&gt;</span> LE     <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFGE     _ B1 B2 <span class="token operator">=&gt;</span> GE     <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFCMPEQ  _ B1 B2 <span class="token operator">=&gt;</span> CMPEQ  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFCMPNEQ _ B1 B2 <span class="token operator">=&gt;</span> CMPNEQ <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFCMPLT  _ B1 B2 <span class="token operator">=&gt;</span> CMPLT  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFCMPGT  _ B1 B2 <span class="token operator">=&gt;</span> CMPGT  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFCMPLE  _ B1 B2 <span class="token operator">=&gt;</span> CMPLE  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IFCMPGE  _ B1 B2 <span class="token operator">=&gt;</span> CMPGE  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> IF <span class="token punctuation">.</span>AnnotationList B1 B2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> FAIL _ <span class="token operator">=&gt;</span> UNIT <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> FAILWITH <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT        _ <span class="token operator">=&gt;</span> IF       <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_EQ     _ <span class="token operator">=&gt;</span> IFEQ     <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_NEQ    _ <span class="token operator">=&gt;</span> IFNEQ    <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_LT     _ <span class="token operator">=&gt;</span> IFLT     <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_LE     _ <span class="token operator">=&gt;</span> IFLE     <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_GT     _ <span class="token operator">=&gt;</span> IFGT     <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_GE     _ <span class="token operator">=&gt;</span> IFGE     <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_CMPEQ  _ <span class="token operator">=&gt;</span> IFCMPEQ  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_CMPNEQ _ <span class="token operator">=&gt;</span> IFCMPNEQ <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_CMPLT  _ <span class="token operator">=&gt;</span> IFCMPLT  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_CMPLE  _ <span class="token operator">=&gt;</span> IFCMPLE  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_CMPGT  _ <span class="token operator">=&gt;</span> IFCMPGT  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_CMPGE  _ <span class="token operator">=&gt;</span> IFCMPGE  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_NONE   _ <span class="token operator">=&gt;</span> IF_NONE  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_SOME   _ <span class="token operator">=&gt;</span> IF_SOME  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_LEFT   _ <span class="token operator">=&gt;</span> IF_LEFT  <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> ASSERT_RIGHT  _ <span class="token operator">=&gt;</span> IF_RIGHT <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> FAIL <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IF_SOME  _ B1 B2 <span class="token operator">=&gt;</span> IF_NONE <span class="token punctuation">.</span>AnnotationList B2 B1 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> IF_RIGHT _ B1 B2 <span class="token operator">=&gt;</span> IF_LEFT <span class="token punctuation">.</span>AnnotationList B2 B1 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SET_CAR _ <span class="token operator">=&gt;</span> CDR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> SWAP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> PAIR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> SET_CDR _ <span class="token operator">=&gt;</span> CAR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>                        PAIR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> MAP_CAR _ Body
        <span class="token operator">=&gt;</span> DUP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
           CDR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
           DIP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span> CAR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> Body <span class="token punctuation">}</span> <span class="token punctuation">;</span>
           SWAP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
           PAIR <span class="token punctuation">.</span>AnnotationList
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> MAP_CDR _ Body
        <span class="token operator">=&gt;</span> DUP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
           CDR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
           Body <span class="token punctuation">;</span>
           SWAP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
           CAR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
           PAIR <span class="token punctuation">.</span>AnnotationList
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">// NOTE: there is no DUP 1 macro --- presumably becuase this is equal to DUP</span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DUP _ <span class="token number">2</span> <span class="token operator">=&gt;</span> DIP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">{</span> DUP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">;</span> SWAP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> DUP _ N <span class="token operator">=&gt;</span> DIP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">(</span>N <span class="token operator">-</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> DUP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">}</span> <span class="token punctuation">;</span> DIG <span class="token punctuation">.</span>AnnotationList N <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">requires</span> N &gt;<span class="token keyword">Int</span> <span class="token number">2</span>
</code></pre>
<h3 id="complex-macro-evaluation">Complex Macro Evaluation</h3>
<p>The following macros require two or more steps to fully process.
We first convert the macro token into a string and trim off any unneeded
prefixes/suffixes.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> DataList <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #DUP<span class="token punctuation">(</span><span class="token keyword">String</span><span class="token punctuation">)</span>                          <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
                    <span class="token operator">|</span> #CDAR<span class="token punctuation">(</span><span class="token keyword">String</span><span class="token punctuation">)</span>                         <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
                    <span class="token operator">|</span> <span class="token string">&quot;#SET_CDAR&quot;</span> <span class="token string">&quot;(&quot;</span> <span class="token keyword">String</span> <span class="token string">&quot;)&quot;</span>            <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
                    <span class="token operator">|</span> <span class="token string">&quot;#MAP_CDAR&quot;</span> <span class="token string">&quot;(&quot;</span> <span class="token keyword">String</span> <span class="token string">&quot;,&quot;</span>  Block <span class="token string">&quot;)&quot;</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
                    <span class="token operator">|</span> #DIP<span class="token punctuation">(</span><span class="token keyword">String</span><span class="token punctuation">,</span> Block<span class="token punctuation">)</span>                   <span class="token punctuation">[</span>function<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> M<span class="token punctuation">:</span>DUPMacro     _   <span class="token operator">=&gt;</span> #DUP<span class="token punctuation">(</span>     #Trim<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>#DUPMacroToString<span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> M<span class="token punctuation">:</span>CDARMacro    _   <span class="token operator">=&gt;</span> #CDAR<span class="token punctuation">(</span>    #Trim<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>#CDARMacroToString<span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> M<span class="token punctuation">:</span>SetCDARMacro _   <span class="token operator">=&gt;</span> #SET_CDAR<span class="token punctuation">(</span>#Trim<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>#SetCDARMacroToString<span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> M<span class="token punctuation">:</span>MapCDARMacro _ B <span class="token operator">=&gt;</span> #MAP_CDAR<span class="token punctuation">(</span>#Trim<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>#MapCDARMacroToString<span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> B<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
  <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> M<span class="token punctuation">:</span>DIPMacro     _ B <span class="token operator">=&gt;</span> #DIP<span class="token punctuation">(</span>     #Trim<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>#DIPMacroToString<span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     B<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Complex macro evaluation proceeds by interpreting the trimmed string as
Michelson instructions.</p>
<ol>
<li>
<p>The <code>DU+P</code> macro is equivalent to <code>DUP n</code> where <code>n</code> is the number of <code>U</code>s,
where <code>DUP n</code> duplicates the <code>n</code>th stack element. Thus, we can infer a
typing rule of the form:</p>
<p><code>x1 ... xn S =&gt; x1 xn ... xn S</code>.</p>
<pre class="language-k"><code><span class="token keyword">rule</span> #DUP<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DUP <span class="token punctuation">.</span>AnnotationList lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span>
</code></pre>
</li>
<li>
<p>The <code>C[AD]+R</code> macro evaluates to successive <code>CAR</code> or <code>CDR</code> instructions for
each <code>A</code> or <code>D</code> in the string. Thus, we can infer a typing rule of the
form:</p>
<p><code>ptype(...x...) S =&gt; x S</code></p>
<p>where <code>ptype</code> is a nested pair type of the required structure.</p>
<pre class="language-k"><code><span class="token keyword">rule</span> #CDAR<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> CAR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> #CDAR<span class="token punctuation">(</span> #Advance<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>S<span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token keyword">requires</span>    lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span> &gt;<span class="token keyword">Int</span> <span class="token number">0</span>
  andThenBool #CharAt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> S<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">String</span> <span class="token string">&quot;A&quot;</span>

<span class="token keyword">rule</span> #CDAR<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> CDR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span> #CDAR<span class="token punctuation">(</span> #Advance<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>S<span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token keyword">requires</span>    lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span> &gt;<span class="token keyword">Int</span> <span class="token number">0</span>
  andThenBool #CharAt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> S<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">String</span> <span class="token string">&quot;D&quot;</span>

<span class="token keyword">rule</span> #CDAR<span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre>
</li>
<li>
<p>The <code>SET_C[AD]+R</code> macro sets a designated leaf element in a nested <code>pair</code>
type with depth <code>n</code> which depends on the sequence of <code>A</code>s and <code>D</code>s in the
macro. Thus, we can infer a typing rule of the form:</p>
<p><code>ptype(...x...) x S =&gt; ptype(...x...) S</code>.</p>
<pre class="language-k"><code><span class="token keyword">rule</span> #SET_CDAR<span class="token punctuation">(</span>S<span class="token punctuation">)</span>
  <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> DUP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
       DIP <span class="token punctuation">.</span>AnnotationList
           <span class="token punctuation">{</span> CAR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
         <span class="token punctuation">{</span> #SET_CDAR<span class="token punctuation">(</span> #Advance<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>S<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">}</span>
           <span class="token punctuation">}</span> <span class="token punctuation">;</span>
       CDR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
       SWAP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
       PAIR <span class="token punctuation">.</span>AnnotationList
     <span class="token punctuation">}</span>
  <span class="token keyword">requires</span>    lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">2</span>
  andThenBool #CharAt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> S<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">String</span> <span class="token string">&quot;A&quot;</span>

<span class="token keyword">rule</span> #SET_CDAR<span class="token punctuation">(</span>S<span class="token punctuation">)</span>
  <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> DUP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
       DIP <span class="token punctuation">.</span>AnnotationList
           <span class="token punctuation">{</span> CDR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
         <span class="token punctuation">{</span> #SET_CDAR<span class="token punctuation">(</span> #Advance<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>S<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">}</span>
           <span class="token punctuation">}</span> <span class="token punctuation">;</span>
       CAR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
       PAIR <span class="token punctuation">.</span>AnnotationList
     <span class="token punctuation">}</span>
  <span class="token keyword">requires</span>    lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">2</span>
  andThenBool #CharAt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> S<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">String</span> <span class="token string">&quot;D&quot;</span>

<span class="token keyword">rule</span> #SET_CDAR<span class="token punctuation">(</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> SET_CAR <span class="token punctuation">.</span>AnnotationList
<span class="token keyword">rule</span> #SET_CDAR<span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> SET_CDR <span class="token punctuation">.</span>AnnotationList
</code></pre>
</li>
<li>
<p>The <code>MAP_C[AD]+R code</code> assumes the following conditions:</p>
<ul>
<li>the macro is applied to a stack of the for <code>ptype S</code> where <code>ptype</code> is a
nested <code>pair</code> type with a designated leaf of depth <code>n</code> which depends on
the sequence of <code>A</code>s and <code>D</code>s in the macro;</li>
<li>the designated leaf value is <code>v</code> with type <code>x</code>;</li>
<li>for the given <code>code</code>, we can infer a typing rule of the form <code>x S =&gt; x S</code></li>
</ul>
<p>Then <code>MAP_C[AD]+R</code> macro transforms the pair by applying <code>code</code> to leaf
value <code>v</code>. Thus, we can infer a typing rule of the form:</p>
<p><code>ptype(...x...) S =&gt; ptype(...x...) S</code>.</p>
<pre class="language-k"><code><span class="token keyword">rule</span> #MAP_CDAR<span class="token punctuation">(</span>S<span class="token punctuation">,</span> Body<span class="token punctuation">)</span>
  <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> DUP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
       DIP <span class="token punctuation">.</span>AnnotationList
           <span class="token punctuation">{</span> CAR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
             <span class="token punctuation">{</span> #MAP_CDAR<span class="token punctuation">(</span> #Advance<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>S<span class="token punctuation">)</span><span class="token punctuation">,</span> Body <span class="token punctuation">)</span> <span class="token punctuation">}</span>
           <span class="token punctuation">}</span> <span class="token punctuation">;</span>
       CDR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
       SWAP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
       PAIR <span class="token punctuation">.</span>AnnotationList
     <span class="token punctuation">}</span>
  <span class="token keyword">requires</span>    lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">2</span>
  andThenBool #CharAt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> S<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">String</span> <span class="token string">&quot;A&quot;</span>

<span class="token keyword">rule</span> #MAP_CDAR<span class="token punctuation">(</span>S<span class="token punctuation">,</span> Body<span class="token punctuation">)</span>
  <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> DUP <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
       DIP <span class="token punctuation">.</span>AnnotationList
           <span class="token punctuation">{</span> CDR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
             <span class="token punctuation">{</span> #MAP_CDAR<span class="token punctuation">(</span> #Advance<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>S<span class="token punctuation">)</span><span class="token punctuation">,</span> Body <span class="token punctuation">)</span> <span class="token punctuation">}</span>
           <span class="token punctuation">}</span> <span class="token punctuation">;</span>
       CAR <span class="token punctuation">.</span>AnnotationList <span class="token punctuation">;</span>
       PAIR <span class="token punctuation">.</span>AnnotationList
     <span class="token punctuation">}</span>
  <span class="token keyword">requires</span>    lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">2</span>
  andThenBool #CharAt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> S<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">String</span> <span class="token string">&quot;D&quot;</span>

<span class="token keyword">rule</span> #MAP_CDAR<span class="token punctuation">(</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span> Body<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> MAP_CAR <span class="token punctuation">.</span>AnnotationList Body
<span class="token keyword">rule</span> #MAP_CDAR<span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">,</span> Body<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> MAP_CDR <span class="token punctuation">.</span>AnnotationList Body
</code></pre>
</li>
<li>
<p>The <code>DII+P</code> macro evaluates to <code>DIP n</code> where <code>n</code> is the number of <code>I</code>s in
the string. Technically, this macro accepts a variant of roman numerals with
characters <code>MDCLXVI</code> where different letters increase the value of <code>n</code> by
more than 1, but, for simplicity, we only accept the consecutive <code>I</code>s.
Its typing rule is equivalent to the typing rule for <code>DIP n code</code></p>
<pre class="language-k"><code><span class="token keyword">rule</span> #DIP<span class="token punctuation">(</span>S<span class="token punctuation">,</span>Body<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DIP <span class="token punctuation">.</span>AnnotationList lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span> Body
</code></pre>
</li>
</ol>
<h4 id="unimplemented-macros">Unimplemented Macros</h4>
<p>The following two macros are left for future implementation work.</p>
<pre class="language-text"><code>  rule &lt;k&gt; M:PairMacro    _ =&gt; #Eval(#Trim(1,1,#PairMacroToString(M)),    M) ... &lt;/k&gt;
  rule &lt;k&gt; M:UnpairMacro  _ =&gt; #Eval(#Trim(2,1,#UnpairMacroToString(M)),  M) ... &lt;/k&gt;
</code></pre>
<h3 id="macro-evaluation-auxiliary-functions">Macro Evaluation Auxiliary Functions</h3>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> <span class="token keyword">String</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #Trim<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">String</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">// -------------------------------------------------</span>
  <span class="token keyword">rule</span> #Trim<span class="token punctuation">(</span>B<span class="token punctuation">,</span> E<span class="token punctuation">,</span> S<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> substrString<span class="token punctuation">(</span>S<span class="token punctuation">,</span> B<span class="token punctuation">,</span> lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token keyword">Int</span> E<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> <span class="token keyword">String</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #CharAt<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">String</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">// ----------------------------------------------</span>
  <span class="token keyword">rule</span> #CharAt<span class="token punctuation">(</span>N<span class="token punctuation">,</span> S<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> substrString<span class="token punctuation">(</span>S<span class="token punctuation">,</span> N<span class="token punctuation">,</span> N <span class="token operator">+</span><span class="token keyword">Int</span> <span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> <span class="token keyword">String</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #Advance<span class="token punctuation">(</span><span class="token keyword">Int</span><span class="token punctuation">,</span> <span class="token keyword">String</span><span class="token punctuation">)</span>  <span class="token punctuation">[</span>function<span class="token punctuation">]</span>
  <span class="token comment">// ------------------------------------------------</span>
  <span class="token keyword">rule</span> #Advance<span class="token punctuation">(</span>N<span class="token punctuation">,</span> S<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> substrString<span class="token punctuation">(</span>S<span class="token punctuation">,</span> N<span class="token punctuation">,</span> lengthString<span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="symbolic-value-processing">Symbolic Value Processing</h2>
<h3 id="extending-functions-to-symbolicdata">Extending functions to <code>SymbolicData</code></h3>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> TypedSymbol <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #TypedSymbol<span class="token punctuation">(</span>TypeName<span class="token punctuation">,</span> Data<span class="token punctuation">)</span>
</code></pre>
<pre class="language-text"><code>  rule [[ #MichelineToNative(S:SymbolicData, T, _, _) =&gt; D ]]
       &lt;symbols&gt; S |-&gt; #TypedSymbol(TN, D) ... &lt;/symbols&gt;
    requires TN ==K #Name(T)

  rule [[ #MichelineToNative(S:SymbolicData, T, _, _) =&gt; S ]]
       &lt;symbols&gt; Syms:Map &lt;/symbols&gt;
    requires notBool (S in_keys(Syms))
</code></pre>
<h3 id="%23createsymbol"><code>#CreateSymbol</code></h3>
<p><code>#CreateSymbol</code> is responsible for setting up the initial symbol table.</p>
<pre class="language-text"><code>  syntax KItem ::= #CreateSymbol(SymbolicData, Type)
  // -----------------------------------------------
  rule &lt;k&gt; (.K =&gt; #MakeFresh(T)) ~&gt;  #CreateSymbol(_, T) ... &lt;/k&gt;
  rule &lt;k&gt; (V ~&gt; #CreateSymbol(N, T)) =&gt; . ... &lt;/k&gt;
       &lt;symbols&gt; M =&gt; M[N &lt;- #TypedSymbol(#Name(T), V)] &lt;/symbols&gt;
    requires isValue(#Name(T), V)
</code></pre>
<h3 id="%22evaluating%22-data">&quot;Evaluating&quot; Data</h3>
<p>The <code>isValue</code> predicate indicates if a <code>Data</code> has been fully evaluated.
It has an untyped and typed variant.</p>
<pre class="language-k"><code>  <span class="token keyword">syntax</span> <span class="token keyword">Bool</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> isValue<span class="token punctuation">(</span>Data<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
  <span class="token comment">// -------------------------------------------------</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>_<span class="token punctuation">:</span>SimpleData<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>None<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>Some V<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> isValue<span class="token punctuation">(</span>V<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>Left V<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> isValue<span class="token punctuation">(</span>V<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>Right V<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> isValue<span class="token punctuation">(</span>V<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>Pair L R<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> isValue<span class="token punctuation">(</span>L<span class="token punctuation">)</span> andBool isValue<span class="token punctuation">(</span>R<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span> <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>

  <span class="token keyword">syntax</span> <span class="token keyword">Bool</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> isValue<span class="token punctuation">(</span>TypeName<span class="token punctuation">,</span> Data<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">,</span> functional<span class="token punctuation">]</span>
  <span class="token comment">// -----------------------------------------------------------</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>nat<span class="token punctuation">,</span>       V<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span>                 <span class="token operator">=&gt;</span> <span class="token boolean">true</span> <span class="token keyword">requires</span> V <span class="token operator">&gt;=</span><span class="token keyword">Int</span> <span class="token number">0</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>int<span class="token punctuation">,</span>       _<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span>                 <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>mutez<span class="token punctuation">,</span>     #Mutez<span class="token punctuation">(</span>V<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token operator">=&gt;</span> <span class="token boolean">true</span> <span class="token keyword">requires</span> #IsLegalMutezValue<span class="token punctuation">(</span>V<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>bool<span class="token punctuation">,</span>      _<span class="token punctuation">:</span><span class="token keyword">Bool</span><span class="token punctuation">)</span>                <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>bytes<span class="token punctuation">,</span>     _<span class="token punctuation">:</span>Bytes<span class="token punctuation">)</span>               <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>string<span class="token punctuation">,</span>    _<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">)</span>              <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>unit<span class="token punctuation">,</span>      Unit<span class="token punctuation">)</span>                  <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>key<span class="token punctuation">,</span>       #Key<span class="token punctuation">(</span>_<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>key_hash<span class="token punctuation">,</span>  #KeyHash<span class="token punctuation">(</span>_<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>signature<span class="token punctuation">,</span> #Signature<span class="token punctuation">(</span>_<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> #Timestamp<span class="token punctuation">(</span>_<span class="token punctuation">:</span><span class="token keyword">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>address<span class="token punctuation">,</span>   #Address<span class="token punctuation">(</span>_<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>chain_id<span class="token punctuation">,</span>  #ChainId<span class="token punctuation">(</span>_<span class="token punctuation">:</span>Bytes<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>operation<span class="token punctuation">,</span> _<span class="token punctuation">:</span>BlockchainOperation<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>

  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>contract T<span class="token punctuation">,</span> #Contract<span class="token punctuation">(</span>#Address<span class="token punctuation">(</span>_<span class="token punctuation">:</span><span class="token keyword">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span>TY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span> <span class="token keyword">requires</span> T <span class="token operator">==</span>K #Name<span class="token punctuation">(</span>TY<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>option _<span class="token punctuation">,</span> None<span class="token punctuation">)</span>                               <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>option T<span class="token punctuation">,</span> Some V<span class="token punctuation">)</span>                             <span class="token operator">=&gt;</span> isValue<span class="token punctuation">(</span>T<span class="token punctuation">,</span> V<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>pair T1 T2<span class="token punctuation">,</span> Pair LV RV<span class="token punctuation">)</span>                <span class="token operator">=&gt;</span> isValue<span class="token punctuation">(</span>T1<span class="token punctuation">,</span> LV<span class="token punctuation">)</span> andBool isValue<span class="token punctuation">(</span>T2<span class="token punctuation">,</span> RV<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>or  T1 _T2<span class="token punctuation">,</span> Left  V<span class="token punctuation">)</span>                   <span class="token operator">=&gt;</span> isValue<span class="token punctuation">(</span>T1<span class="token punctuation">,</span> V<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>or _T1  T2<span class="token punctuation">,</span> Right V<span class="token punctuation">)</span>                   <span class="token operator">=&gt;</span> isValue<span class="token punctuation">(</span>T2<span class="token punctuation">,</span> V<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>lambda T1 T2<span class="token punctuation">,</span> #Lambda<span class="token punctuation">(</span>T1<span class="token punctuation">,</span>T2<span class="token punctuation">,</span> _<span class="token punctuation">:</span>Block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>

  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>list _<span class="token punctuation">,</span> _<span class="token punctuation">:</span>InternalList<span class="token punctuation">)</span>   <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>set _<span class="token punctuation">,</span>  _<span class="token punctuation">:</span>Set<span class="token punctuation">)</span>            <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>_<span class="token punctuation">:</span>MapTypeName _ _<span class="token punctuation">,</span> _<span class="token punctuation">:</span>Map<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>

  <span class="token keyword">rule</span> isValue<span class="token punctuation">(</span>_<span class="token punctuation">,</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span> <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>
</code></pre>
<pre class="language-k"><code>    <span class="token keyword">syntax</span> Data <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> <span class="token string">&quot;#hole&quot;</span>

    <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> Pair V1 V2 <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>V1 <span class="token operator">~&gt;</span> Pair #hole V2<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> notBool isValue<span class="token punctuation">(</span>V1<span class="token punctuation">)</span>
    <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> Pair V1 V2 <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>V2 <span class="token operator">~&gt;</span> Pair V1 #hole<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>V1<span class="token punctuation">)</span> andBool notBool isValue<span class="token punctuation">(</span>V2<span class="token punctuation">)</span>
    <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>V1 <span class="token operator">~&gt;</span> Pair #hole V2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Pair V1 V2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>V1<span class="token punctuation">)</span>
    <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>V2 <span class="token operator">~&gt;</span> Pair V1 #hole<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Pair V1 V2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>V2<span class="token punctuation">)</span>

    <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> Some V <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>V <span class="token operator">~&gt;</span> Some #hole<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> notBool isValue<span class="token punctuation">(</span>V<span class="token punctuation">)</span>
    <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>V <span class="token operator">~&gt;</span> Some #hole<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Some V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>V<span class="token punctuation">)</span>
    <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> Left V <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>V <span class="token operator">~&gt;</span> Left #hole<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> notBool isValue<span class="token punctuation">(</span>V<span class="token punctuation">)</span>
    <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>V <span class="token operator">~&gt;</span> Left #hole<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Left V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>V<span class="token punctuation">)</span>
    <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> Right V <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>V <span class="token operator">~&gt;</span> Right #hole<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> notBool isValue<span class="token punctuation">(</span>V<span class="token punctuation">)</span>
    <span class="token keyword">rule</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>V <span class="token operator">~&gt;</span> Right #hole<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Right V <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>k</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">requires</span> isValue<span class="token punctuation">(</span>V<span class="token punctuation">)</span>
</code></pre>
<h3 id="%23makefresh"><code>#MakeFresh</code></h3>
<p><code>#MakeFresh</code> is responsible for generating a fresh value of a given type.</p>
<pre class="language-text"><code>  syntax Data ::= #MakeFresh(Type)

  rule &lt;k&gt; #MakeFresh(nat       _:AnnotationList) =&gt; #Assume(?V &gt;=Int 0)             ~&gt; ?V:Int         ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(mutez     _:AnnotationList) =&gt; #Assume(#IsLegalMutezValue(?V)) ~&gt; #Mutez(?V:Int) ... &lt;/k&gt;

  rule &lt;k&gt; #MakeFresh(bool      _:AnnotationList) =&gt; ?_:Bool                ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(int       _:AnnotationList) =&gt; ?_:Int                 ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(bytes     _:AnnotationList) =&gt; ?_:Bytes               ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(string    _:AnnotationList) =&gt; ?_:String              ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(unit      _:AnnotationList) =&gt; Unit                   ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(key       _:AnnotationList) =&gt; #Key(?_:String)        ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(key_hash  _:AnnotationList) =&gt; #KeyHash(?_:String)    ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(signature _:AnnotationList) =&gt; #Signature(?_:String)  ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(timestamp _:AnnotationList) =&gt; #Timestamp(?_:Int)     ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(address   _:AnnotationList) =&gt; #Address(?_:String)    ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(chain_id  _:AnnotationList) =&gt; #ChainId(?_:Bytes)     ... &lt;/k&gt;
  // TODO: should we expand into the three separate kinds of Blockchain operations?
  rule &lt;k&gt; #MakeFresh(operation _:AnnotationList) =&gt; ?_:BlockchainOperation ... &lt;/k&gt;

  rule &lt;k&gt; #MakeFresh(list      _:AnnotationList _:Type)        =&gt; ?_:InternalList                       ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(set       _:AnnotationList _:Type)        =&gt; ?_:Set                                ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(map       _:AnnotationList _:Type _:Type) =&gt; ?_:Map                                ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(big_map   _:AnnotationList _:Type _:Type) =&gt; ?_:Map                                ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(contract  _:AnnotationList T)             =&gt; #Contract(#Address(?_:String),T)      ... &lt;/k&gt;

  rule &lt;k&gt; #MakeFresh(pair _:AnnotationList T1 T2)
        =&gt; (Pair #MakeFresh(T1) #MakeFresh(T2))
           ...
       &lt;/k&gt;

  rule &lt;k&gt; #MakeFresh(option _:AnnotationList T) =&gt; None               ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(option _:AnnotationList T) =&gt; Some #MakeFresh(T) ... &lt;/k&gt;

  rule &lt;k&gt; #MakeFresh(or _:AnnotationList T1 T2) =&gt; Left  #MakeFresh(T1) ... &lt;/k&gt;
  rule &lt;k&gt; #MakeFresh(or _:AnnotationList T1 T2) =&gt; Right #MakeFresh(T2) ... &lt;/k&gt;
</code></pre>
<p>We implement fresh lambdas as fresh uninterpreted functions.</p>
<pre class="language-text"><code>  rule &lt;k&gt; #MakeFresh(lambda    _:AnnotationList T1 T2)
        =&gt; #Lambda(#Name(T1), #Name(T2), { #Uninterpreted(!Id, #Name(T1), #Name(T2)) })
           ...
       &lt;/k&gt;

  syntax Instruction ::= #Uninterpreted(id: Int, arg: TypeName, return: TypeName)
  syntax Data ::= uninterpreted(id: Int, arg: Data) [function, functional, no-evaluators]
  // ------------------------------------------------------------------------------------
  rule &lt;k&gt; #Uninterpreted(Id, ArgT, RetT)
        =&gt; #Assume(uninterpreted(Id, Arg) == #MakeFresh(#Type(RetT)))
           ...
       &lt;/k&gt;
       &lt;stack&gt; [ArgT Arg] ; SS =&gt; [RetT uninterpreted(Id, Arg):Data] ; SS &lt;/stack&gt;
    requires isValue(ArgT, Arg)
</code></pre>
<pre class="language-k"><code><span class="token keyword">endmodule</span>
</code></pre>
<p>This function implements a relaxed equality check between two data elements.
In particular, it handles the wildcard match behavior described in the <code>.tzt</code>
format proposal and discards list type information as discussed earlier.</p>
<pre class="language-k"><code><span class="token keyword">module</span> MATCHER
  <span class="token keyword">imports</span> MICHELSON<span class="token operator">-</span>COMMON
  <span class="token keyword">imports</span> UNIT<span class="token operator">-</span>TEST<span class="token operator">-</span>COMMON<span class="token operator">-</span>SYNTAX

  <span class="token keyword">syntax</span> <span class="token keyword">Bool</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> #Matches<span class="token punctuation">(</span>Data<span class="token punctuation">,</span> Data<span class="token punctuation">)</span> <span class="token punctuation">[</span>function<span class="token punctuation">]</span> <span class="token comment">// Expected, Actual</span>

  <span class="token comment">// This covers any structurally different data. (e.g. (Left 1) vs (Right 1))</span>
  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>D1<span class="token punctuation">,</span> D2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> D1 <span class="token operator">==</span>K D2 <span class="token punctuation">[</span>owise<span class="token punctuation">]</span>

  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>_<span class="token punctuation">:</span>Wildcard<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>

  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span><span class="token punctuation">.</span>InternalList<span class="token punctuation">,</span> <span class="token punctuation">.</span>InternalList<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>L1 <span class="token punctuation">;</span><span class="token punctuation">;</span> Ls1<span class="token punctuation">,</span> L2 <span class="token punctuation">;</span><span class="token punctuation">;</span> Ls2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>L1<span class="token punctuation">,</span> L2<span class="token punctuation">)</span> andBool #Matches<span class="token punctuation">(</span>Ls1<span class="token punctuation">,</span> Ls2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span><span class="token punctuation">.</span>Set<span class="token punctuation">,</span> <span class="token punctuation">.</span>Set<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>SetItem<span class="token punctuation">(</span>S1<span class="token punctuation">)</span> Ss1<span class="token punctuation">,</span> SetItem<span class="token punctuation">(</span>S2<span class="token punctuation">)</span> Ss2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>S1<span class="token punctuation">,</span> S2<span class="token punctuation">)</span> andBool #Matches<span class="token punctuation">(</span>Ss1<span class="token punctuation">,</span> Ss2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span><span class="token punctuation">.</span>Map<span class="token punctuation">,</span> <span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span><span class="token punctuation">(</span>K <span class="token operator">|</span><span class="token operator">-</span>&gt; V1<span class="token punctuation">)</span> M1<span class="token punctuation">,</span> <span class="token punctuation">(</span>K <span class="token operator">|</span><span class="token operator">-</span>&gt; V2<span class="token punctuation">)</span> M2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>V1<span class="token punctuation">,</span> V2<span class="token punctuation">)</span> andBool #Matches<span class="token punctuation">(</span>M1<span class="token punctuation">,</span> M2<span class="token punctuation">)</span>

  <span class="token keyword">syntax</span> Data <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">=</span> FailedStack

  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>Create_contract <span class="token punctuation">{</span> C <span class="token punctuation">}</span> O1 M1 D1 I1<span class="token punctuation">,</span>
                Create_contract <span class="token punctuation">{</span> C <span class="token punctuation">}</span> O2 M2 D2 I2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span> andBool
       #Matches<span class="token punctuation">(</span>O1<span class="token punctuation">,</span> O2<span class="token punctuation">)</span> andBool
       #Matches<span class="token punctuation">(</span>M1<span class="token punctuation">,</span> M2<span class="token punctuation">)</span> andBool
       #Matches<span class="token punctuation">(</span>D1<span class="token punctuation">,</span> D2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>Transfer_tokens D1 M1 A1 I1<span class="token punctuation">,</span>
                Transfer_tokens D2 M2 A2 I2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span> andBool
       #Matches<span class="token punctuation">(</span>D1<span class="token punctuation">,</span> D2<span class="token punctuation">)</span> andBool
       #Matches<span class="token punctuation">(</span>M1<span class="token punctuation">,</span> M2<span class="token punctuation">)</span> andBool
       #Matches<span class="token punctuation">(</span>A1<span class="token punctuation">,</span> A2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>Set_delegate O1 I1<span class="token punctuation">,</span>
                Set_delegate O2 I2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>I1<span class="token punctuation">,</span> I2<span class="token punctuation">)</span> andBool #Matches<span class="token punctuation">(</span>O1<span class="token punctuation">,</span> O2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>Pair L1 R1<span class="token punctuation">,</span> Pair L2 R2<span class="token punctuation">)</span>
    <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>L1<span class="token punctuation">,</span> L2<span class="token punctuation">)</span> andBool #Matches<span class="token punctuation">(</span>R1<span class="token punctuation">,</span> R2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>Some D1<span class="token punctuation">,</span> Some D2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>D1<span class="token punctuation">,</span> D2<span class="token punctuation">)</span>

  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>Left D1<span class="token punctuation">,</span> Left D2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>D1<span class="token punctuation">,</span> D2<span class="token punctuation">)</span>
  <span class="token keyword">rule</span> #Matches<span class="token punctuation">(</span>Right D1<span class="token punctuation">,</span> Right D2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> #Matches<span class="token punctuation">(</span>D1<span class="token punctuation">,</span> D2<span class="token punctuation">)</span>
<span class="token keyword">endmodule</span>
</code></pre>
</body></html></div>
        </main>
      </div>
    </div>
<footer class="app-footer text-md-left text-center">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-2 mb-md-0 mb-4">
        <span class="pr-md-5 pr-0 py-3">
          <a href="https://runtimeverification.com" target="_blank">
            <picture>
              <source
                srcset="../assets/img/rv-logo-dark.png"
                media="(prefers-color-scheme: dark)"
              />
              <img
                class="pr-3 footer-logo"
                src="../assets/img/rv-logo.png"
                alt="Runtime Verification Inc logo"
              />
            </picture>
          </a>
        </span>
      </div>
      <div class="col-md-6 mb-md-0 mb-4"></div>
      <div class="col-md-4 text-md-right">
        <p class="copyright">
          &copy; 2020 Runtime Verification Inc. All right reserved.
        </p>
      </div>
    </div>
  </div>
</footer>

<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-163311512-1"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", "UA-163311512-1");
</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Typist/1.2/typist.min.js"></script>
    <script src="../assets/js/index.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-QL0D8HRYFW"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-QL0D8HRYFW");
    </script>
  </body>
</html>
